---
title: "2 - Transform_z_scores"
author: "Jory Curry"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    code_folding: show
    df_print: paged
    toc: true
    toc_depth: 5
    toc_float: true
    theme: readable
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
```

```{r library, warning=FALSE, include=FALSE, message=FALSE}
library(tidyverse)
library(purrr)
library(broom)
library(DescTools)
library(scales)
library(DT)
library(ggrepel)
```

```{r 1.Transform, echo=TRUE}
clean_dat <- read_csv(file = "Data/Alamar_Blue_Tidy_Data_29chems_outliers_rm.csv")

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#Testing visually for outliers in control groups
test <- clean_dat %>%
  filter(Dose == "Dose_6")
p_control <- test %>%
  ggplot(aes(x = Animal, y = Delta_Fluorescence, group = Group, colour = Group, label = Animal)) +
  geom_point() +
  ggrepel::geom_label_repel() +
  facet_wrap(~ Chemical)
#No obvious outliers!!!

#Will remove if necessary
#index <- clean_dat$Chemical == "DES" & clean_dat$Dose == "Dose_6" & clean_dat$Group == "B"
#replace <- replace(clean_dat$Relative_Delta_Fluorescence, index, NA) #Replace DES Control group B with NAs in the relative delta fluorescence value
#clean_dat$Relative_Delta_Fluorescence <- replace
#NN-Dimethylformamide also has some outliers in Group A
#index <- clean_dat$Chemical == "NN-Dimethylformamide" & clean_dat$Dose == "Dose_6" & clean_dat$Animal %in% c(46, 47)
#replace <- replace(clean_dat$Relative_Delta_Fluorescence, index, NA) #Replace NN-Dimethylformamide Control group A with NAs in the relative delta fluorescence value
#clean_dat$Relative_Delta_Fluorescence <- replace
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  
control_mean_sd <- clean_dat %>%
  group_by(Chemical) %>%
  filter(Dose == "Dose_6") %>%
  summarise(control_mean = mean(Delta_Fluorescence, na.rm = TRUE),
         control_sd = sd(Delta_Fluorescence, na.rm = TRUE))

clean_dat <- inner_join(clean_dat, control_mean_sd, by = c("Chemical"))

z_dat <- clean_dat %>%
  group_by(Chemical) %>%
  mutate(z_score = (Delta_Fluorescence-control_mean)/control_sd) %>%
  dplyr::select(Chemical, Dose, `Dose(mg/L)`, Animal, Group, control_mean, control_sd, Delta_Fluorescence, z_score, Outlier)

write_csv(z_dat, file = "Data/z-score_data.csv")
```

```{r 2.Transform, echo=FALSE, warning=FALSE}
#hist(z_dat$z_score)

z_dat %>%
  group_by(Chemical) %>%
  ggplot(aes(sample = z_score)) +
  geom_qq() +
  geom_qq_line() +
  facet_wrap(~ Chemical, scales = "free") +
  ylab("Sample") +
  xlab("Theoretical") +
  theme_classic() +
  ggtitle("QQ plots showing approximately normal distributions for each experiment
          with outliers removed from control groups")
```

```{r 2.Transform, echo=FALSE, warning=FALSE}
#Homogeneity of Variance
LeveneResults <- z_dat %>%
  group_by(Chemical) %>%
  summarise(LeveneTest(z_score ~ as.factor(`Dose(mg/L)`)))
#Adding an is.significant column to easily parse significant values in a spreadsheet
LeveneResults <- LeveneResults %>%
  na.omit() %>%
  mutate(is.significant = if_else(
    condition = `Pr(>F)` < 0.05,
    true = TRUE,
    false = FALSE
  ))

DT::datatable(LeveneResults)
```

```{r 3.ANOVA, echo=TRUE}
z_dat <- z_dat %>%
  mutate(Dose = factor(Dose, levels = c("Dose_6", "Dose_5", "Dose_4", "Dose_3", "Dose_2", "Dose_1"), ordered = TRUE),
         `Dose(mg/L)` = as.factor(`Dose(mg/L)`),
         Group = as.factor(Group))

#ANCOVA
model <- z_dat %>%
  group_by(Chemical) %>%
  nest() %>%
  mutate(model = purrr::map(data, ~ aov(z_score ~ Dose + Group, data = .))) %>%
  dplyr::select(-data)

ANCOVA <- z_dat %>%
  group_by(Chemical) %>%
  nest() %>%
  mutate(model = purrr::map(data, ~ aov(z_score ~ Dose + Group, data = .))) %>%
  dplyr::select(-data) %>%
  mutate(model_tidy = purrr::map(model, broom::tidy)) %>%
  unnest(model_tidy) %>%
  mutate(adj_p.value = p.adjust(p.value, method = "fdr")) %>%
  mutate(is.significant = if_else(
    condition = adj_p.value <= 0.05,
    true = TRUE,
    false = FALSE
  ))

write_csv(ANCOVA, file = "Output/z-score_ANCOVA.csv")

DT::datatable(ANCOVA)
```

```{r 4.Post-Hoc, echo=TRUE}
set.seed(89473)

AllDoses <-
  read.csv(file = "MetaData.csv",
           skip = 1,
           header = TRUE)
AllDoses_2 <- AllDoses %>%
  gather(key = Dose, value = "Dose(mg/L)", Dose_1:Dose_6) %>%
  mutate(Dose = if_else(condition = Dose == "Dose_6", true = "Control", false = Dose))

#Performing Dunnett's test on an ANCOVA

library(multcomp)

fit_dunnett <- model %>%
  dplyr::mutate(Dunnett = map(model, ~ glht(.x, linfct = mcp(Dose="Dunnett")))) %>%
  dplyr::mutate(tidy_Dunnett = map(Dunnett, ~ broom::tidy(.x))) %>%
  dplyr::mutate(tidy_Dunnett_1 = map(tidy_Dunnett, ~ mutate(.x, Chemical = Chemical)))

Dunnett_comb <- plyr::ldply(fit_dunnett$tidy_Dunnett_1) %>%
  dplyr::mutate(Dose = str_split(contrast, pattern = " - ", simplify = TRUE)[,1]) %>%
  dplyr::select(Chemical, Dose, estimate, std.error, statistic, adj.p.value) %>%
  dplyr::mutate(adj.p.value = p.adjust(adj.p.value, method = "fdr")) # p-values not already adjusted

#Emmeans for multiple comparisons
control <- c("Dose_6")
option3_1 <- fit_dunnett %>%
    mutate(option3 = map(model, ~ multcomp::cld(emmeans::emmeans(object = .x, specs = pairwise~Dose), details = TRUE, Letters = letters, alpha = 0.05)))

# #Emmmeans data frame
option3 <- option3_1 %>%
    dplyr::select(option3) %>%
    mutate(data = map(option3, pluck(.x = "emmeans"))) %>%
    mutate(data2 = map(data, ~ as_tibble(x = .x))) %>%
    dplyr::select(data2) %>%
    unnest(cols = c(data2))
# 
# 
model <- fit_dunnett$Dunnett
model_means_cld <- option3 %>%
  group_by(Chemical) %>%
  dplyr::mutate(Group = forcats::fct_reorder(Dose, emmean, .na_rm = TRUE)) %>%
  dplyr::mutate(cont_group = .group) %>%
  dplyr::mutate(Dose = if_else(condition = Dose == "Dose_6", true = "Control", false = Dose),
                Group = if_else(condition = Dose == "Dose_6", true = "Control", false = Dose)) %>%
  dplyr::mutate(
    Dose = factor(Dose, levels = c("Control", "Dose_5", "Dose_4", "Dose_3", "Dose_2", "Dose_1"), ordered = TRUE),
    Group = factor(Dose, levels = c("Control", "Dose_5", "Dose_4", "Dose_3", "Dose_2", "Dose_1"), ordered = TRUE)
  ) %>%
  dplyr::mutate(adj_factor = emmean/4) %>%
  dplyr::inner_join(AllDoses_2)

write_csv(Dunnett_comb, "Output/_z_Score_ANCOVA_Dunnetts_Results.csv")
write_csv(model_means_cld, "Output/z_score_ANCOVA_Dunnetts_Compact_Letter_Display_EmMeans.csv")

#This was my old code to run Dunnett's test using a one-way ANOVA. However, we know now that we must use a two-way ANOVA because of interactions between the subgroups and dose groups. So we will use a different method that utilized the `multcomp` package

# Dunnett_results <- z_dat %>%
#   group_by(Chemical) %>%
#   nest() %>%
#   mutate(model = map(data, ~ DunnettTest(
#     x = .$z_score, g = .$`Dose(mg/L)`
#   ), data = .)) #Performing the Dunnett's test and saving it is a variable
# 
# #Creating list of summaries
# #Since the PostHocTest object cannot be coerced to a tidy tibble using tidy()... we got creative
# Dunnett_list <-
#   list() #What we are trying to do is index the results and see what the significant results were... so we are using a list which can be later coerced into a tibble to easily index...
# for (i in 1:length(unique(clean_dat$Chemical))) {
#   Dunnett_list[[Dunnett_results$Chemical[i]]] <-
#     Dunnett_results$model[[i]][["0"]] %>% #Take Dunnett's test results without any of the fancy summary information and shove it into a named list
#     as.data.frame() %>% #Coerce to a data frame temporarily so what we can take the row names of the reults and turn them into a variable with rownames_to_column
#     rownames_to_column(var = "dose")
# }
# Dunnett_comb <-
#   plyr::ldply(Dunnett_list) #this function combines all of the lists together and gives them a variable name according to the chemical
# Dunnett_comb$dose = substr(Dunnett_comb$dose,
#                            start = 1,
#                            stop = nchar(Dunnett_comb$dose) - 2) %>%
#   as.numeric() #Here we are fixing the dose column... the dose column has the test dose related to the control... but we just want to see what the test dose is without it giving us redundant information about the comparison to the control for every observation...
# Dunnett_comb <- as_tibble(Dunnett_comb) #Coerce to a tidy tibble
# 
# #Now just to add one more column
# Dunnett_comb <- Dunnett_comb %>%
#   mutate(adj_p.value = p.adjust(pval, method = "fdr")) %>%
#   mutate(is.significant = if_else(
#     condition = pval < 0.05,
#     true = TRUE,
#     false = FALSE
#   ))

write_csv(Dunnett_comb, file = "Output/z-score_Dunnett.csv")

Dunnett_Sig_Results <-
  Dunnett_comb[which(Dunnett_comb$adj.p.value <= 0.05), ]


DT::datatable(Dunnett_Sig_Results)
```

```{r 5.Plot, include=FALSE}
y_values_4_geom_text <- z_dat %>%
  group_by(Chemical, Dose) %>%
  summarise(max_y = max(z_score, na.rm = TRUE),
            min_y = min(z_score, na.rm = TRUE),
            median_y = median(z_score, na.rm = TRUE))



gg_Dunnett <- Dunnett_comb %>%
  inner_join(y_values_4_geom_text) %>%
  inner_join(AllDoses_2) %>%
  inner_join(model_means_cld)

gg_ANCOVA <- ANCOVA %>%
  dplyr::filter(term == "Dose") %>%
  dplyr::select(Chemical, term, adj_p.value, is.significant)

gg_data <- z_dat %>%
  inner_join(gg_ANCOVA) %>%
  na.omit() %>%
  group_by(Chemical) %>%
  mutate(z_score_show = as.numeric(
    dplyr::between(
      x = z_score,
      left = quantile(z_score, na.rm = TRUE)[2] - 1.5 * IQR(z_score, na.rm = TRUE),
      right = quantile(z_score, na.rm = TRUE)[4] + 1.5 * IQR(z_score, na.rm = TRUE)
    )
  )) %>%
  mutate(Dose = if_else(condition = Dose == "Dose_6", true = "Control", false = Dose)) %>%
  mutate(
    z_score_ol_rm = if_else(z_score_show == 1, true = z_score, false = NA),
    Dose = factor(Dose, levels = c("Control", "Dose_5", "Dose_4", "Dose_3", "Dose_2", "Dose_1"), ordered = TRUE)
  ) %>%
  dplyr::select(
    Chemical,
    Group,
    Dose,
    `Dose(mg/L)`,
    z_score,
    z_score_show,
    z_score_ol_rm,
    term,
    adj_p.value,
    is.significant
  )
```

```{r 6.Plot, include=FALSE}
p <- ggplot() +
  #y axis
  scale_y_continuous(
    name = "Z-scores",
    breaks = pretty_breaks(),
    expand = expansion(mult = (c(0.2, 0.2)))
  ) +
  #x axis
  scale_x_discrete(
    name = "Dose (mg/L)",
    expand = expansion(mult = (c(0.2, 0.2))),
    breaks = waiver()
  ) +
  #layout
  theme_classic() +
  #black data points
  geom_point(
    data = gg_data,
    aes(y = z_score, x = as.factor(`Dose(mg/L)`), group = as.factor(`Dose(mg/L)`)),
    position = position_nudge(x = -0.2),
    show.legend = FALSE
  ) +
  #scale_color_manual(values = c("TRUE" = "black", "FALSE" = "grey")) +
  #black boxplot
  # geom_boxplot(
  #   data = gg_data,
  #   aes(y = z_score, x = as.factor(`Dose(mg/L)`), group = as.factor(`Dose(mg/L)`)),
  #   width = 0.2,
  #   outlier.shape = NA,
  #   position = position_nudge(x = -0.3),
  #   show.legend = FALSE
  # ) +
  #red mean value
  geom_point(
    data = model_means_cld,
    aes(y = emmean, x = as.factor(`Dose(mg/L)`)),
    size = 2,
    color = "red",
    position = position_nudge(x = 0)
  ) +
  #red mean errorbar
  geom_errorbar(
    data = model_means_cld,
    aes(ymin = lower.CL, ymax = upper.CL, x = as.factor(`Dose(mg/L)`)),
    width = 0.05,
    color = "red",
    position = position_nudge(x = 0)
  ) +
  #red asterix
  geom_text(
    data = gg_Dunnett,
    aes(
      label = if_else(
        condition = adj.p.value > 0.1,
        true = "",
        false = if_else(
          condition = adj.p.value <= 0.1 &
            adj.p.value > 0.05,
          true = "",
          if_else(
            condition = adj.p.value <= 0.05 &
              adj.p.value > 0.01,
            true = "*",
            false = if_else(
              condition = adj.p.value <= 0.01 &
                adj.p.value > 0.001,
              true = "**",
              false = if_else(adj.p.value <= 0.001 &
                                adj.p.value >= 0, true = "***", false = "")
            )
          )
        )
      ),
      group = as.factor(`Dose(mg/L)`),
      y = emmean,
      x = as.factor(`Dose(mg/L)`),
    ),
    position = position_nudge(x = 0.1, y = 0),
    hjust = 0,
    vjust = 0,
    color = "red",
    size = 6
  ) +
  #red letters
  # geom_text(
  #   data = model_means_cld,
  #   aes(
  #     y = emmean,
  #     x = as.factor(`Dose(mg/L)`),
  #     label = str_trim(cont_group),
  #   ),
  #   position = position_nudge(x = 0.2, y = -0.1),
  #   hjust = 0.5,
  #   vjust = 1,
  #   color = "red"
  # ) +
  facet_wrap( ~ Chemical, scales = "free_x") +
  labs(
    caption = str_wrap("Black dots represent response values (the z-score - relative to the control group). Red points represent the estimated marginal means for each dose group. Red error bars represent the 95% confidence intervals of the estimated marginal means. Red asterix represent statistical significance of the post hoc Dunnett's test (*** - p < 0.001, ** - p < 0.01, * - p < 0.05).", width = 280))

```

```{r 7.Plot, include=FALSE}
ggsave(
  width = 1920,
  height = 1080,
  units = "px",
  scale = 3,
  filename = "Output/Images/Alamar_Blue_z-scores.png",
  plot = p,
  path = getwd(),
  device = "png"
)
```

```{r 8.Plot,echo=FALSE}
knitr::include_graphics("Output/Images/Alamar_Blue_z-scores.png")
```
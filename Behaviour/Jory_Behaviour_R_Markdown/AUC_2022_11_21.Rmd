---
title: "Area under the curve curvep analysis for different binning methods"
author: "Jory Curry"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    code_folding: show
    df_print: paged
    toc: true
    toc_depth: 5
    toc_float: true
    theme: readable
params:
  value: totaldist
  sample_size: 10
---

```{r 1setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
options(scipen = 9)
```

```{r 2libraries, include=FALSE}
library(knitr)
library(kableExtra)
library(gridExtra)
library(rlang)
library(Rcurvep)
library(DescTools)
library(plyr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(stringr)
library(tibble)
library(data.table)
library(car)
library(lazyeval)
library(DT)
source("Functions/cal_auc_simi_endpoints.R")
source("Functions/behavioural_endpoint_calc.R")
source("Functions/RCurveP_Data_Wrangling_Functions.R")
```


# Toxicology Behavioural Analysis Report

## Version Control
```{r 3version_control, comment="", class.source ='fold-hide'}
# - My Machine Info:
#   - R version 4.2.1 (2022-06-23)
#   - Platform: x86_64-pc-linux-gnu (64-bit)         5.11.0-34-generic / Ubuntu 22.04.1 LTS
#   - Desktop: GNOME 3.36.5
#   - Hardware: CPU - Intel Core i5-9400F 6 core 4.1GHz / RAM - 15924MiB
```

```{r 4_importing_dat, include=FALSE}
fishBehavDat <- read_csv(file = "Data/fishBehavDat.csv")
fishBehavDatBin5 <- read_csv(file = "Data/fishBehavDatBin5.csv")
fishBehavDatBinLD <- read_csv(file = "Data/fishBehavDatBinLD.csv")
```

```{r 8directory, include=FALSE}
dir <- paste0(getwd(), "/Data/All")
```

```{r 9directory_files_filenames, include=FALSE}
fileNames <- list.files("Data/Raw") #Get the name of each .csv file
chemicalNames <- str_split(string = fileNames, pattern = ".csv", simplify = TRUE)[,1] #Identify the chemicals included in the files
metaData <- read.csv(file = "Data/MetaData.csv") #Import the Meta Data that includes information about the data in the folders
#CAS is the Chemical Abstract Service, MOA is the Mode of Action. This table includes useful information about the exposure concentrations for each chemical dose in mg/L. We'll use this later to create our final data frame
#HighDose <- setNames(metaData[,6], chemicalNames) #subsetting metadata
doseData <- metaData %>%
  select(plate_id, Dose1:Control) %>%
  gather(key = Dose, value = "Dose_mg_L", Dose1:Control)
number_of_dose_groups_per_chem <- 5 # Set this to the number of dose groups you have
```

```{r 1_remove_outlier_control_fish, include=FALSE}
BoxPlotOutliers <- fishBehavDat %>%
  filter(Dose == "Control") %>%
  group_by(plate_id, embryo_id) %>%
  summarise(cummulative_param = sum(get(params$value), na.rm = TRUE)) %>%
  group_by(plate_id) %>%
  summarise(Q1 = quantile(cummulative_param, 0.25),
         Q3 = quantile(cummulative_param, 0.75),
         IQR = IQR(cummulative_param),
         cummulative_param = cummulative_param,
         embryo_id = embryo_id) %>%
  mutate(lower_limit = (Q1 - 1.5*IQR),
         upper_limit = (Q3 + 1.5*IQR)) %>%
  group_by(plate_id) %>%
  mutate(z_score = (cummulative_param - mean(cummulative_param))/sd(cummulative_param)) %>%
  mutate(outlier_iqr = if_else(condition = cummulative_param > (Q1 - 1.5*IQR) & cummulative_param < (Q3 + 1.5*IQR), true = FALSE, false = TRUE)) %>%
  mutate(outlier_z = if_else(condition = z_score > 3, true = TRUE, false = FALSE))

ggBoxPlotOutliers <- BoxPlotOutliers %>%
  ggplot(data = ., mapping = aes(y = cummulative_param)) +
  geom_boxplot() +
  geom_label(inherit.aes = FALSE, x = 0, aes(y = cummulative_param, color = embryo_id, label = embryo_id)) +
  geom_point(inherit.aes = FALSE, x = 0, aes(y = cummulative_param, color = embryo_id)) +
  facet_wrap(~plate_id, scales = "free") +
  theme_classic()

BoxPlotOutliersRemove <- BoxPlotOutliers %>%
  filter(outlier_iqr | outlier_z == TRUE) %>%
  summarise(plate_id = plate_id, embryo_id = embryo_id)

print(ggBoxPlotOutliers)


#Remove any outliers before data transmformation based off of the animal's cumulative paramater across the entire assay
#fishBehavDat
temp <- semi_join(fishBehavDat, BoxPlotOutliersRemove, by = c("plate_id", "embryo_id")) %>%
  mutate(across(
    .cols = c("inact","inadur",
              "smlct","smldur","smldist","activedur",
              "larct","lardur","lardist","totaldist"),
    .fns = ~ replace(x = ., values = NA)
  )) %>%
  mutate(outliers = TRUE)
temp2 <- anti_join(fishBehavDat, BoxPlotOutliersRemove, by = c("plate_id", "embryo_id"))
fishBehavDat <- bind_rows(temp, temp2)

#fishBehavDatBin5
temp <- semi_join(fishBehavDatBin5, BoxPlotOutliersRemove, by = c("plate_id", "embryo_id")) %>%
  mutate(across(
    .cols = c("inact","inadur",
              "smlct","smldur","smldist","activedur",
              "larct","lardur","lardist","totaldist"),
    .fns = ~ replace(x = ., values = NA)
  )) %>%
  mutate(outliers = TRUE)
temp2 <- anti_join(fishBehavDatBin5, BoxPlotOutliersRemove, by = c("plate_id", "embryo_id"))
fishBehavDatBin5 <- bind_rows(temp, temp2)

#fishBehavDatBinLD
temp <- semi_join(fishBehavDatBinLD, BoxPlotOutliersRemove, by = c("plate_id", "embryo_id")) %>%
  mutate(across(
    .cols = c("inact","inadur",
              "smlct","smldur","smldist","activedur",
              "larct","lardur","lardist","totaldist"),
    .fns = ~ replace(x = ., values = NA)
  )) %>%
  mutate(outliers = TRUE)
temp2 <- anti_join(fishBehavDatBinLD, BoxPlotOutliersRemove, by = c("plate_id", "embryo_id"))
fishBehavDatBinLD <- bind_rows(temp, temp2)

rm(BoxPlotOutliers, BoxPlotOutliersRemove, ggBoxPlotOutliers, temp, temp2)
```

## Analysis - Quantity Endpoints - Area Under the Curve


Take the raw totaldist values and put them in a data frame with the headers:

- plate_id 
- embryo_id
- is_VC
- time_end
- variable of choice (e.g. totaldist, swim velocity, etc.)

The create_auc_endpoints function is going to calculate the area under the curve for each chemical

```{r 87AreaUnderCurveEndpoint, include = FALSE, message=FALSE, warning=FALSE}
auc_endps <-
  list(
    Dark_1 = seq(1, 5, by = 1),
    Light_1 = seq(6, 10, by = 1),
    Dark_2 = seq(11, 15, by = 1),
    Light_2 = seq(16, 20, by = 1),
    Dark_3 = seq(21, 25, by = 1),
    Light_3 = seq(26, 30, by = 1)
  )
lfishBehavDat5 <- fishBehavDatBin5 %>%
  filter(Cycle != "Acclimation") %>%
  mutate(time_end = time_end-20) %>%
  mutate(log_dose = log10(Dose_mg_L)) %>%
  mutate(plate_id = plate_id, embryo_id = embryo_id, time_end = time_end, value = totaldist) %>%
  select(plate_id, embryo_id, time_end, Dose_mg_L, log_dose, value) %>%
  arrange(time_end) %>%
  split(., ~ plate_id)

lauc_all <- list()
for (i in chemicalNames){
temp <- create_auc_endpoints(d = lfishBehavDat5[[i]], segments = auc_endps) 
lauc_all[[i]] <- temp[[1]]
}
auc_all <- ldply(lauc_all)

auc_all <- auc_all %>%
  #filter(plate_id %in% c("BPA", "BPAF", "TGSH", "EE2", "DES")) %>% #For BPA and Replacements
  mutate(endpoint_value_log10 = log10(endpoint_value + 1)) %>%
  mutate(
    Dose = str_split(
      string = embryo_id,
      pattern = "_",
      simplify = TRUE
    )[, 1],
    embryo_id = str_split(
      string = embryo_id,
      pattern = "_",
      simplify = TRUE
    )[, 2]
  )
auc_join <- auc_all %>%
  filter(Dose == "Control") %>%
  group_by(plate_id, endpoint) %>%
  mutate(
    median_value = median(endpoint_value_log10),
    Dose = NULL,
    endpoint_value = NULL,
    endpoint_value_log10 = NULL,
    log_dose = NULL,
    Dose_mg_L = NULL
  )
auc_norm <- auc_all %>%
  full_join(auc_join, by = c(".id", "plate_id", "embryo_id", "endpoint")) %>%
  mutate(endpoint_value_norm = (endpoint_value_log10 - median_value) * 100) %>%
  mutate(Cycle = if_else(
    condition = endpoint %in% c("Dark_1", "Dark_2", "Dark_3"),
    true = "Dark",
    false = "Light"
  )) %>%
  mutate(Dose = factor(
    Dose,
    levels = c("Control", "Dose5", "Dose4", "Dose3", "Dose2", "Dose1"),
    ordered = TRUE
  ))

rm(auc_join, auc_all, lauc_all, auc_endps)
```

```{r 88PlotAucEndpoints, echo=FALSE}
auc_norm %>%
  ggplot(aes(x = Dose, y = endpoint_value_norm)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0, aes(color = embryo_id, shape = Cycle)) +
  facet_wrap(~ plate_id, scales = "free") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
# auc_norm %>%
#   ggplot(aes(x = Dose, y = endpoint_value_norm)) +
#   geom_boxplot(outlier.shape = NA) +
#   geom_jitter(width = 0.1, height = 0, aes(color = embryo_id, shape = Cycle)) +
#   ylim(-100,100)
```

```{r 88.1Remove_Outliers}
temp <- auc_norm %>%
   mutate(Q1 = quantile(endpoint_value_norm, 0.25), Q3 = quantile(endpoint_value_norm, 0.75)) %>%
  mutate(IQR = IQR(endpoint_value_norm)) %>%
  mutate(outlier = if_else(condition = endpoint_value_norm > (Q1 - 1.5*IQR) & endpoint_value_norm < (Q3 + 1.5*IQR), true = FALSE, false = TRUE)) %>%
  mutate(lower_limit = (Q1 - 1.5*IQR),
         upper_limit = (Q3 + 1.5*IQR))

outliers <- temp %>%
  filter(outlier == TRUE) %>%
  ungroup()

temp <- temp %>%
  anti_join(outliers)

rm(outliers)
```

```{r 88.2PlotAucEndpoints, echo=FALSE}
# p <- temp %>%
#   ggplot(aes(x = Dose, y = endpoint_value_norm)) +
#   geom_boxplot(outlier.shape = NA) +
#   geom_jitter(width = 0.1, height = 0, aes(color = embryo_id, shape = Cycle)) +
#   facet_wrap(~ plate_id, scales = "free") +
#   theme_minimal() +
#   theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p1 <- temp %>%
  filter(Cycle == "Dark") %>%
  ggplot(aes(x = Dose, y = endpoint_value_norm)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0, aes(color = embryo_id, shape = Cycle)) +
  facet_wrap(~ plate_id, scales = "free") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p2 <- temp %>%
  filter(Cycle == "Light") %>%
  ggplot(aes(x = Dose, y = endpoint_value_norm)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0, aes(color = embryo_id, shape = Cycle)) +
  facet_wrap(~ plate_id, scales = "free") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

#---------------------------------------------------------------------#
p3 <- temp %>%
  filter(endpoint == "Dark_1") %>%
  ggplot(aes(x = Dose, y = endpoint_value_norm)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0, aes(color = embryo_id, shape = endpoint)) +
  facet_wrap(~ plate_id, scales = "free") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p4 <- temp %>%
  filter(endpoint == "Dark_2") %>%
  ggplot(aes(x = Dose, y = endpoint_value_norm)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0, aes(color = embryo_id, shape = endpoint)) +
  facet_wrap(~ plate_id, scales = "free") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p5 <- temp %>%
  filter(endpoint == "Dark_3") %>%
  ggplot(aes(x = Dose, y = endpoint_value_norm)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0, aes(color = embryo_id, shape = endpoint)) +
  facet_wrap(~ plate_id, scales = "free") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#---------------------------------------------------------------------#
p6 <- temp %>%
  filter(endpoint == "Light_1") %>%
  ggplot(aes(x = Dose, y = endpoint_value_norm)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0, aes(color = embryo_id, shape = endpoint)) +
  facet_wrap(~ plate_id, scales = "free") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p7 <- temp %>%
  filter(endpoint == "Light_2") %>%
  ggplot(aes(x = Dose, y = endpoint_value_norm)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0, aes(color = embryo_id, shape = endpoint)) +
  facet_wrap(~ plate_id, scales = "free") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p8 <- temp %>%
  filter(endpoint == "Light_3") %>%
  ggplot(aes(x = Dose, y = endpoint_value_norm)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0, aes(color = embryo_id, shape = endpoint)) +
  facet_wrap(~ plate_id, scales = "free") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p_list <- list(p1, p2, p3, p4, p5, p6, p7, p8)
names(p_list) <- c("Dark", "Light", "Dark_1", "Dark_2", "Dark_3", "Light_1", "Light_2", "Light_3")
```

### Boxplots by endpoint {.tabset}
```{r 88.3AUC_norm_plots, echo = FALSE, results = 'asis', warning=FALSE, message=FALSE, out.height="1080px", out.width="1920px"}
for (i in seq_along(p_list)){
  temp <- p_list[[i]]
  cat("#####", names(p_list)[i], " \n")
  print(temp)
  cat(' \n\n')
}
```

### {-}

```{r 89Prep_rCurveP, include = FALSE}
auc_norm_no_cntrl <- temp %>%
  filter(Dose != "Control") %>%
  rename(resp = endpoint_value_norm, conc = log_dose, chemical = .id,) %>%
  select(endpoint, chemical, conc, resp)

auc_norm <- temp %>%
  filter(Dose != "Control") %>%
  rename(resp = endpoint_value_norm, conc = log_dose, chemical = .id,) %>%
  select(endpoint, chemical, conc, resp)

rm(temp, p1, p2,)
```


### Negative Direction

```{r 90_Prepare_AUC_rCurveP/Simulated_Curves, include=FALSE}
# All 3 Light Dark Cycles
set.seed(892734)

test <-
  estimate_dataset_bmr(
    combi_run_rcurvep(
      auc_norm_no_cntrl,
      n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = seq(5, 95, by = 5),
      RNGE = -1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
    ),
    plot = FALSE
  )

temp_auc_norm_LD_no_cntrl <- auc_norm_no_cntrl %>%
  mutate(endpoint = str_split(string = endpoint, pattern = "_", simplify = TRUE)[,1])


# Just the Two Light or Dark cycle

test_LD <- estimate_dataset_bmr(
    combi_run_rcurvep(
      temp_auc_norm_LD_no_cntrl,
      n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = seq(5, 95, by = 5),
      RNGE = -1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
    ),
    plot = FALSE
  )
```

```{r 91bmr_auc, echo = FALSE}
test$outcome %>%
  select(endpoint, qc, cor_exp_fit, cor_lm_fit, bmr_exp, bmr_ori) %>%
  kable(
    col.names = c(
      "Endpoint",
      "Quality Control Message",
      "Correlation of expotential fit",
      "Correlation of linear model fit",
      "BMR of exponential model",
      "BMR of linear model"
    ),
    align = 'llrrrr',
    caption = "Table 8. Summary of the estimated BMR"
  ) %>%
  kable_styling() %>%
  scroll_box()
```

```{r 91.1bmr_auc, echo = FALSE}
test_LD$outcome %>%
  select(endpoint, qc, cor_exp_fit, cor_lm_fit, bmr_exp, bmr_ori) %>%
  kable(
    col.names = c(
      "Endpoint",
      "Quality Control Message",
      "Correlation of expotential fit",
      "Correlation of linear model fit",
      "BMR of exponential model",
      "BMR of linear model"
    ),
    align = 'llrrrr',
    caption = "Table 8. Summary of the estimated BMR"
  ) %>%
  kable_styling() %>%
  scroll_box()
```

```{r 92Pull_BMRs, include = FALSE}
test$outcome[is.na(test$outcome)] = 0
test_LD$outcome[is.na(test_LD$outcome)] = 0

bmr_thresh_Dark_1 <- test$outcome %>%
  filter(endpoint == "Dark_1") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_Dark_2 <- test$outcome %>%
  filter(endpoint == "Dark_2") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_Dark_3 <- test$outcome %>%
  filter(endpoint == "Dark_3") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_Light_1 <- test$outcome %>%
  filter(endpoint == "Light_1") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_Light_2 <- test$outcome %>%
  filter(endpoint == "Light_2") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_Light_3 <- test$outcome %>%
  filter(endpoint == "Light_3") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_Dark <- test_LD$outcome %>%
  filter(endpoint == "Dark") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_Light <- test_LD$outcome %>%
  filter(endpoint == "Light") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)
```

```{r 93RcurveP_AUC, include = FALSE}
set.seed(976)
Dark_1_out <- auc_norm_no_cntrl %>%
  filter(endpoint == "Dark_1") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Dark_1,
      RNGE = -1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)


set.seed(9089)
Dark_2_out <- auc_norm_no_cntrl %>%
  filter(endpoint == "Dark_2") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Dark_2,
      RNGE = -1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)


set.seed(1359)  
Dark_3_out <- auc_norm_no_cntrl %>%
  filter(endpoint == "Dark_3") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Dark_3,
      RNGE = -1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)


set.seed(5346) 
Light_1_out <- auc_norm_no_cntrl %>%
  filter(endpoint == "Light_1") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Light_1,
      RNGE = -1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)

  
set.seed(6842)
Light_2_out <- auc_norm_no_cntrl %>%
  filter(endpoint == "Light_2") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Light_2,
      RNGE = -1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)


set.seed(1208)
Light_3_out <- auc_norm_no_cntrl %>%
  filter(endpoint == "Light_3") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Light_3,
      RNGE = -1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)
  
set.seed(47)
Light_out <- temp_auc_norm_LD_no_cntrl %>%
  filter(endpoint == "Light") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Light,
      RNGE = -1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)

set.seed(347)
Dark_out <- temp_auc_norm_LD_no_cntrl %>%
  filter(endpoint == "Dark") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Dark,
      RNGE = -1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)
```


```{r 95_Processed_Rcurvep_obj_wrangling, include = FALSE}
#This code chunk requires some cleanup... makre repititive tasks into functions

#Changed all hit confidence filters to zero to not filter out any results, even those with low confidence values because BPA and alternatives generally have very little effect on locomotor patterns SO FAR



## Light_1
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Light_1_summary <- summarise_rcurvep_results(resp_set = Light_1_out$result$resp_set, act_set = Light_1_out$result$act_set, act_summary = Light_1_out$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Light_1 <- simulated_curves_Light_1_summary %>%
  filter(hit == 1)

#confident_curves_Light_1 <- confident_hits(simulated_curves_Light_1_summary, reject_hit_conf_under = 0.5)
#No confident Curves

bmds_Light_1 <- simulated_curves_Light_1_summary %>%
  group_by(chemical) %>%
  summarise(
    median_POD = unique(median_POD),
    cil_POD = unique(cil_POD),
    mean_POD = unique(mean_POD),
    ciu_POD = unique(ciu_POD),
    POD_med = unique(POD_med),
    hit_confidence = unique(hit_confidence),
    lowest_conc = unique(lowest_conc),
    highest_conc = unique(highest_conc)
  )
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light_2
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Light_2_summary <- summarise_rcurvep_results(resp_set = Light_2_out$result$resp_set, act_set = Light_2_out$result$act_set, act_summary = Light_2_out$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Light_2 <- simulated_curves_Light_2_summary %>%
  filter(hit == 1)

#confident_curves_Light_2 <- confident_hits(simulated_curves_Light_2_summary, reject_hit_conf_under = 0.5)
#No confident Curves

bmds_Light_2 <- simulated_curves_Light_2_summary %>%
  group_by(chemical) %>%
  summarise(
    median_POD = unique(median_POD),
    cil_POD = unique(cil_POD),
    mean_POD = unique(mean_POD),
    ciu_POD = unique(ciu_POD),
    POD_med = unique(POD_med),
    hit_confidence = unique(hit_confidence),
    lowest_conc = unique(lowest_conc),
    highest_conc = unique(highest_conc)
  )
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light_3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Light_3_summary <- summarise_rcurvep_results(resp_set = Light_3_out$result$resp_set, act_set = Light_3_out$result$act_set, act_summary = Light_3_out$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Light_3 <- simulated_curves_Light_3_summary %>%
  filter(hit == 1)

#confident_curves_Light_3 <- confident_hits(simulated_curves_Light_3_summary, reject_hit_conf_under = 0.5)
#No confident Curves

bmds_Light_3 <- simulated_curves_Light_3_summary %>%
  group_by(chemical) %>%
  summarise(
    median_POD = unique(median_POD),
    cil_POD = unique(cil_POD),
    mean_POD = unique(mean_POD),
    ciu_POD = unique(ciu_POD),
    POD_med = unique(POD_med),
    hit_confidence = unique(hit_confidence),
    lowest_conc = unique(lowest_conc),
    highest_conc = unique(highest_conc)
  )
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#


## Dark_1
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Dark_1_summary <- summarise_rcurvep_results(resp_set = Dark_1_out$result$resp_set, act_set = Dark_1_out$result$act_set, act_summary = Dark_1_out$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Dark_1 <- simulated_curves_Dark_1_summary %>%
  filter(hit == 1)

#confident_curves_Dark_1 <- confident_hits(simulated_curves_Dark_1_summary, reject_hit_conf_under = 0.5)
#No confident Curves

bmds_Dark_1 <- simulated_curves_Dark_1_summary %>%
  group_by(chemical) %>%
  summarise(
    median_POD = unique(median_POD),
    cil_POD = unique(cil_POD),
    mean_POD = unique(mean_POD),
    ciu_POD = unique(ciu_POD),
    POD_med = unique(POD_med),
    hit_confidence = unique(hit_confidence),
    lowest_conc = unique(lowest_conc),
    highest_conc = unique(highest_conc)
  )
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark_2
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Dark_2_summary <- summarise_rcurvep_results(resp_set = Dark_2_out$result$resp_set, act_set = Dark_2_out$result$act_set, act_summary = Dark_2_out$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Dark_2 <- simulated_curves_Dark_2_summary %>%
  filter(hit == 1)

#confident_curves_Dark_2 <- confident_hits(simulated_curves_Dark_2_summary, reject_hit_conf_under = 0.5)
#No confident Curves

bmds_Dark_2 <- simulated_curves_Dark_2_summary %>%
  group_by(chemical) %>%
  summarise(
    median_POD = unique(median_POD),
    cil_POD = unique(cil_POD),
    mean_POD = unique(mean_POD),
    ciu_POD = unique(ciu_POD),
    POD_med = unique(POD_med),
    hit_confidence = unique(hit_confidence),
    lowest_conc = unique(lowest_conc),
    highest_conc = unique(highest_conc)
  )
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark_3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Dark_3_summary <- summarise_rcurvep_results(resp_set = Dark_3_out$result$resp_set, act_set = Dark_3_out$result$act_set, act_summary = Dark_3_out$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Dark_3 <- simulated_curves_Dark_3_summary %>%
  filter(hit == 1)

#confident_curves_Dark_3 <- confident_hits(simulated_curves_Dark_3_summary, reject_hit_conf_under = 0.5)
#No confident Curves

bmds_Dark_3 <- simulated_curves_Dark_3_summary %>%
  group_by(chemical) %>%
  summarise(
    median_POD = unique(median_POD),
    cil_POD = unique(cil_POD),
    mean_POD = unique(mean_POD),
    ciu_POD = unique(ciu_POD),
    POD_med = unique(POD_med),
    hit_confidence = unique(hit_confidence),
    lowest_conc = unique(lowest_conc),
    highest_conc = unique(highest_conc)
  )
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#



## Light
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Light_summary <- summarise_rcurvep_results(resp_set = Light_out$result$resp_set, act_set = Light_out$result$act_set, act_summary = Light_out$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Light <- simulated_curves_Light_summary %>%
  filter(hit == 1)

#confident_curves_Light <- confident_hits(simulated_curves_Light_summary, reject_hit_conf_under = 0.5)
#No confident Curves

bmds_Light <- simulated_curves_Light_summary %>%
  group_by(chemical) %>%
  summarise(
    median_POD = unique(median_POD),
    cil_POD = unique(cil_POD),
    mean_POD = unique(mean_POD),
    ciu_POD = unique(ciu_POD),
    POD_med = unique(POD_med),
    hit_confidence = unique(hit_confidence),
    lowest_conc = unique(lowest_conc),
    highest_conc = unique(highest_conc)
  )
 
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Dark_summary <- summarise_rcurvep_results(resp_set = Dark_out$result$resp_set, act_set = Dark_out$result$act_set, act_summary = Dark_out$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Dark <- simulated_curves_Dark_summary %>%
  filter(hit == 1)

#confident_curves_Dark <- confident_hits(simulated_curves_Dark_summary, reject_hit_conf_under = 0.5)
#No confident Curves

bmds_Dark <- simulated_curves_Dark_summary %>%
  group_by(chemical) %>%
  summarise(
    median_POD = unique(median_POD),
    cil_POD = unique(cil_POD),
    mean_POD = unique(mean_POD),
    ciu_POD = unique(ciu_POD),
    POD_med = unique(POD_med),
    hit_confidence = unique(hit_confidence),
    lowest_conc = unique(lowest_conc),
    highest_conc = unique(highest_conc)
  )
  
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
```

```{r 96curve_processing_auc, include = FALSE}
## Light 1
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Light_1 <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Light_1_summary, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Light_1, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Light_1[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "green") +
  # geom_line(data = confident_curves_Light_1[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  # geom_line(data = confident_curves_Light_1[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Light_1, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Light_1, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Light_1, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Light_1, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Light_1, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = bmds_Light_1, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light_2
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Light_2 <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Light_2_summary, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Light_2, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Light_2[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "green") +
  # geom_line(data = confident_curves_Light_2[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Light_2[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Light_2, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Light_2, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Light_2, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Light_2, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Light_2, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = bmds_Light_2, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light_3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Light_3 <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Light_3_summary, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Light_3, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Light_3[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "green") +
  # geom_line(data = confident_curves_Light_3[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Light_3[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Light_3, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Light_3, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Light_3, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Light_3, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Light_3, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = bmds_Light_3, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#


## Dark_1
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Dark_1 <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Dark_1_summary, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Dark_1, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Dark_1[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "green") +
  # geom_line(data = confident_curves_Dark_1[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Dark_1[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Dark_1, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Dark_1, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Dark_1, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Dark_1, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Dark_1, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = bmds_Dark_1, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark_2
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Dark_2 <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Dark_2_summary, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Dark_2, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Dark_2[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "green") +
  # geom_line(data = confident_curves_Dark_2[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Dark_2[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Dark_2, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Dark_2, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Dark_2, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Dark_2, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Dark_2, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = bmds_Dark_2, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark_3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Dark_3 <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Dark_3_summary, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Dark_3, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Dark_3[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "green") +
  # geom_line(data = confident_curves_Dark_3[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Dark_3[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Dark_3, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Dark_3, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Dark_3, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Dark_3, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Dark_3, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = bmds_Dark_3, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#


## Light
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Light <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Light_summary, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Light, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Light[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "green") +
  # geom_line(data = confident_curves_Light[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Light[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Light, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Light, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Light, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Light, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Light, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = bmds_Light, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#


## Dark
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Dark <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Dark_summary, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Dark, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Dark[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "green") +
  # geom_line(data = confident_curves_Dark[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Dark[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Dark, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Dark, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Dark, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Dark, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Dark, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = bmds_Dark, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
```

```{r 97run_fits_auc, include=FALSE}
# Use the Normalized data as input
temp <- auc_norm_no_cntrl %>%
  select(endpoint, chemical, conc, resp) %>%
  group_by(chemical)

temp_LD <- temp_auc_norm_LD_no_cntrl %>%
  select(endpoint, chemical, conc, resp) %>%
  group_by(chemical)

## Light_1
temp_Light_1 <- temp %>%
  filter(endpoint == "Light_1")

Light_1_fitted <- run_fit(
  create_dataset(d = temp_Light_1, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = -1
)

## Light_2
temp_Light_2 <- temp %>%
  filter(endpoint == "Light_2")

Light_2_fitted <- run_fit(
  create_dataset(d = temp_Light_2, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = -1
)

## Light_3
temp_Light_3 <- temp %>%
  filter(endpoint == "Light_3")

Light_3_fitted <- run_fit(
  create_dataset(d = temp_Light_3, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = -1
)
## Dark_1
temp_Dark_1 <- temp %>%
  filter(endpoint == "Dark_1")

Dark_1_fitted <- run_fit(
  create_dataset(d = temp_Dark_1, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = -1
)

## Dark_2
temp_Dark_2 <- temp %>%
  filter(endpoint == "Dark_2")

Dark_2_fitted <- run_fit(
  create_dataset(d = temp_Dark_2, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = -1
)


## Dark_3
temp_Dark_3 <- temp %>%
  filter(endpoint == "Dark_3")

Dark_3_fitted <- run_fit(
  create_dataset(d = temp_Dark_3, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = -1
)

## Light
temp_Light <- temp_LD %>%
  filter(endpoint == "Light")
  
Light_fitted <- run_fit(
  create_dataset(d = temp_Light, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = -1
)

## Dark
temp_Dark <- temp_LD %>%
  filter(endpoint == "Dark")
  
Dark_fitted <- run_fit(
  create_dataset(d = temp_Dark, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = -1
)
```

```{r 98wrangling_fitted_auc_data, include=FALSE}
#Wrangling

## Light_1
###############################################################################
Light_1_fitted_output <- summarize_fit_output(d = Light_1_fitted, thr_resp = bmr_thresh_Light_1)

Light_1_fitted_output_summary <- summarise_fitted_results(resp_set = Light_1_fitted_output$result$resp_set, act_set = Light_1_fitted_output$result$act_set, act_summary = Light_1_fitted_output$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Light_1_summary <- Light_1_fitted_output_summary %>%
  filter(hit == 1)

#confident_fitted_hits_Light_1 <- confident_hits(summary_dat = Light_1_fitted_output_1, reject_hit_conf_under = 0.5)
#None

bmds_fitted_Light_1 <- Light_1_fitted_output_summary %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
###############################################################################

## Light_2
###############################################################################
Light_2_fitted_output <- summarize_fit_output(d = Light_2_fitted, thr_resp = bmr_thresh_Light_2)

Light_2_fitted_output_summary <- summarise_fitted_results(resp_set = Light_2_fitted_output$result$resp_set, act_set = Light_2_fitted_output$result$act_set, act_summary = Light_2_fitted_output$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Light_2_summary <- Light_2_fitted_output_summary %>%
  filter(hit == 1)

#confident_fitted_hits_Light_2 <- confident_hits(summary_dat = Light_2_fitted_output_1, reject_hit_conf_under = 0.5)
#None

bmds_fitted_Light_2 <- Light_2_fitted_output_summary %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
###############################################################################

## Light_3
###############################################################################
Light_3_fitted_output <- summarize_fit_output(d = Light_3_fitted, thr_resp = bmr_thresh_Light_3)

Light_3_fitted_output_summary <- summarise_fitted_results(resp_set = Light_3_fitted_output$result$resp_set, act_set = Light_3_fitted_output$result$act_set, act_summary = Light_3_fitted_output$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Light_3_summary <- Light_3_fitted_output_summary %>%
  filter(hit == 1)

#confident_fitted_hits_Light_3 <- confident_hits(summary_dat = Light_3_fitted_output_1, reject_hit_conf_under = 0.5)
#None

bmds_fitted_Light_3 <- Light_3_fitted_output_summary %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
###############################################################################

## Dark_1
###############################################################################
Dark_1_fitted_output <- summarize_fit_output(d = Dark_1_fitted, thr_resp = bmr_thresh_Dark_1)

Dark_1_fitted_output_summary <- summarise_fitted_results(resp_set = Dark_1_fitted_output$result$resp_set, act_set = Dark_1_fitted_output$result$act_set, act_summary = Dark_1_fitted_output$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Dark_1_summary <- Dark_1_fitted_output_summary %>%
  filter(hit == 1)

#confident_fitted_hits_Dark_1 <- confident_hits(summary_dat = Dark_1_fitted_output_1, reject_hit_conf_under = 0.5)
#None

bmds_fitted_Dark_1 <- Dark_1_fitted_output_summary %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
###############################################################################

## Dark_2
###############################################################################
Dark_2_fitted_output <- summarize_fit_output(d = Dark_2_fitted, thr_resp = bmr_thresh_Dark_2)

Dark_2_fitted_output_summary <- summarise_fitted_results(resp_set = Dark_2_fitted_output$result$resp_set, act_set = Dark_2_fitted_output$result$act_set, act_summary = Dark_2_fitted_output$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Dark_2_summary <- Dark_2_fitted_output_summary %>%
  filter(hit == 1)

#confident_fitted_hits_Dark_2 <- confident_hits(summary_dat = Dark_2_fitted_output_1, reject_hit_conf_under = 0.5)
#None

bmds_fitted_Dark_2 <- Dark_2_fitted_output_summary %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
###############################################################################

## Dark_3
###############################################################################
Dark_3_fitted_output <- summarize_fit_output(d = Dark_3_fitted, thr_resp = bmr_thresh_Dark_3)

Dark_3_fitted_output_summary <- summarise_fitted_results(resp_set = Dark_3_fitted_output$result$resp_set, act_set = Dark_3_fitted_output$result$act_set, act_summary = Dark_3_fitted_output$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Dark_3_summary <- Dark_3_fitted_output_summary %>%
  filter(hit == 1)

#confident_fitted_hits_Dark_3 <- confident_hits(summary_dat = Dark_3_fitted_output_1, reject_hit_conf_under = 0.5)
#None

bmds_fitted_Dark_3 <- Dark_3_fitted_output_summary %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
###############################################################################

## Light
###############################################################################
Light_fitted_output <- summarize_fit_output(d = Light_fitted, thr_resp = bmr_thresh_Light)

Light_fitted_output_summary <- summarise_fitted_results(resp_set = Light_fitted_output$result$resp_set, act_set = Light_fitted_output$result$act_set, act_summary = Light_fitted_output$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Light_summary <- Light_fitted_output_summary %>%
  filter(hit == 1)

#confident_fitted_hits_Light <- confident_hits(summary_dat = Light_fitted_output_1, reject_hit_conf_under = 0.5)
#None

bmds_fitted_Light <- Light_fitted_output_summary %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
###############################################################################

## Dark
###############################################################################
Dark_fitted_output <- summarize_fit_output(d = Dark_fitted, thr_resp = bmr_thresh_Dark)

Dark_fitted_output_summary <- summarise_fitted_results(resp_set = Dark_fitted_output$result$resp_set, act_set = Dark_fitted_output$result$act_set, act_summary = Dark_fitted_output$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Dark_summary <- Dark_fitted_output_summary %>%
  filter(hit == 1)

#confident_fitted_hits_Dark <- confident_hits(summary_dat = Dark_fitted_output_1, reject_hit_conf_under = 0.5)
#None

bmds_fitted_Dark <- Dark_fitted_output_summary %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
###############################################################################
```


```{r 99plot_fitted_aucs, include=FALSE}
#Plotting

## Light_1
p_Light_1_fitted <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Light_1_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Light_1_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Light_1_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Light_1[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Light_1[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Light_1[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Light_1, linetype = "dashed", color = "red") +
  # geom_hline(yintercept = bmr_thresh_Light_1, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Light_1, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Light_1, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Light_1, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Light_1, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Light_1_fitted_output_summary, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

## Light_2
p_Light_2_fitted <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Light_2_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Light_2_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Light_2_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Light_2[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Light_2[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Light_2[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Light_2, linetype = "dashed", color = "red") +
  # geom_hline(yintercept = bmr_thresh_Light_2, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Light_2, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Light_2, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Light_2, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Light_2, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Light_2_fitted_output_summary, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

## Light_3
p_Light_3_fitted <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Light_3_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Light_3_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Light_3_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Light_3[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Light_3[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Light_3[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Light_3, linetype = "dashed", color = "red") +
  # geom_hline(yintercept = bmr_thresh_Light_3, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Light_3, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Light_3, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Light_3, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Light_3, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Light_3_fitted_output_summary, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

## Dark_1
p_Dark_1_fitted <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Dark_1_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Dark_1_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Dark_1_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Dark_1[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Dark_1[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Dark_1[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Dark_1, linetype = "dashed", color = "red") +
  # geom_hline(yintercept = bmr_thresh_Dark_1, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Dark_1, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Dark_1, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Dark_1, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Dark_1, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Dark_1_fitted_output_summary, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

## Dark_2
p_Dark_2_fitted <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Dark_2_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Dark_2_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Dark_2_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Dark_2[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Dark_2[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Dark_2[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Dark_2, linetype = "dashed", color = "red") +
  # geom_hline(yintercept = bmr_thresh_Dark_2, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Dark_2, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Dark_2, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Dark_2, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Dark_2, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Dark_2_fitted_output_summary, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

## Dark_3
p_Dark_3_fitted <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Dark_3_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Dark_3_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Dark_3_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Dark_3[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Dark_3[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Dark_3[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Dark_3, linetype = "dashed", color = "red") +
   # geom_hline(yintercept = bmr_thresh_Dark_3, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Dark_3, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Dark_3, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Dark_3, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Dark_3, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Dark_3_fitted_output_summary, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

## Light
p_Light_fitted <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Light_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Light_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Light_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Light[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Light[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Light[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Light, linetype = "dashed", color = "red") +
  # geom_hline(yintercept = bmr_thresh_Light, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Light, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Light, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Light, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Light, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Light_fitted_output_summary, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

## Dark
p_Dark_fitted <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Dark_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Dark_fitted_output_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Dark_summary, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Dark[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Dark[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Dark[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = -bmr_thresh_Dark, linetype = "dashed", color = "red") +
  # geom_hline(yintercept = bmr_thresh_Dark, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Dark, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Dark, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Dark, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Dark, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Dark_fitted_output_summary, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = 40, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())

```


### Positive Direction

```{r 100AUC_rCurveP, include=FALSE}
testP <-
  estimate_dataset_bmr(
    combi_run_rcurvep(
      auc_norm_no_cntrl,
      n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = seq(5, 95, by = 5),
      RNGE = 1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
    ),
    plot = FALSE
  )

temp_auc_norm_LD_no_cntrlP <- auc_norm_no_cntrl %>%
  mutate(endpoint = str_split(string = endpoint, pattern = "_", simplify = TRUE)[,1])

test_LDP <- estimate_dataset_bmr(
    combi_run_rcurvep(
      temp_auc_norm_LD_no_cntrlP,
      n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = seq(5, 95, by = 5),
      RNGE = 1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
    ),
    plot = FALSE
  )
```

```{r 101bmr_auc, echo = FALSE}
testP$outcome %>%
  select(endpoint, qc, cor_exp_fit, cor_lm_fit, bmr_exp, bmr_ori) %>%
  kable(
    col.names = c(
      "Endpoint",
      "Quality Control Message",
      "Correlation of expotential fit",
      "Correlation of linear model fit",
      "BMR of exponential model",
      "BMR of linear model"
    ),
    align = 'llrrrr',
    caption = "Table 8. Summary of the estimated BMR"
  ) %>%
  kable_styling() %>%
  scroll_box()
```

```{r 101.1bmr_auc, echo = FALSE}
test_LDP$outcome %>%
  select(endpoint, qc, cor_exp_fit, cor_lm_fit, bmr_exp, bmr_ori) %>%
  kable(
    col.names = c(
      "Endpoint",
      "Quality Control Message",
      "Correlation of expotential fit",
      "Correlation of linear model fit",
      "BMR of exponential model",
      "BMR of linear model"
    ),
    align = 'llrrrr',
    caption = "Table 8. Summary of the estimated BMR"
  ) %>%
  kable_styling() %>%
  scroll_box()
```

```{r 103Pull_BMRs, include = FALSE}
testP$outcome[which(is.na(test$outcome))] = 0
test_LDP$outcome[which(is.na(test$outcome))] = 0

bmr_thresh_Dark_1P <- testP$outcome %>%
  filter(endpoint == "Dark_1") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_Dark_2P <- testP$outcome %>%
  filter(endpoint == "Dark_2") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_Dark_3P <- testP$outcome %>%
  filter(endpoint == "Dark_3") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_Light_1P <- testP$outcome %>%
  filter(endpoint == "Light_1") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_Light_2P <- testP$outcome %>%
  filter(endpoint == "Light_2") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_Light_3P <- testP$outcome %>%
  filter(endpoint == "Light_3") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_DarkP <- test_LDP$outcome %>%
  filter(endpoint == "Dark") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)

bmr_thresh_LightP <- test_LDP$outcome %>%
  filter(endpoint == "Light") %>%
  mutate(bmr = if_else(condition = .$cor_lm_fit > .$cor_exp_fit, true = .$bmr_ori, false = .$bmr_exp)) %>%
  pull(bmr)
```

```{r 104RcurveP_AUC, include = FALSE}
set.seed(976)
Dark_1_outP <- auc_norm_no_cntrl %>%
  filter(endpoint == "Dark_1") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Dark_1,
      RNGE = 1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)


set.seed(9089)
Dark_2_outP <- auc_norm_no_cntrl %>%
  filter(endpoint == "Dark_2") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Dark_2,
      RNGE = 1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)


set.seed(1359)  
Dark_3_outP <- auc_norm_no_cntrl %>%
  filter(endpoint == "Dark_3") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Dark_3,
      RNGE = 1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)


set.seed(5346) 
Light_1_outP <- auc_norm_no_cntrl %>%
  filter(endpoint == "Light_1") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Light_1,
      RNGE = 1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)

  
set.seed(6842)
Light_2_outP <- auc_norm_no_cntrl %>%
  filter(endpoint == "Light_2") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Light_2,
      RNGE = 1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)


set.seed(1208)
Light_3_outP <- auc_norm_no_cntrl %>%
  filter(endpoint == "Light_3") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Light_3,
      RNGE = 1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)
  
set.seed(47)
Light_outP <- temp_auc_norm_LD_no_cntrl %>%
  filter(endpoint == "Light") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Light,
      RNGE = 1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)

set.seed(347)
Dark_outP <- temp_auc_norm_LD_no_cntrl %>%
  filter(endpoint == "Dark") %>%
  combi_run_rcurvep(., n_samples = params$sample_size,
      #Increase this number to 100 or 1000 for better results (takes a long time to run)
      keep_sets = c("act_set", "resp_set", "fp_set"),
      TRSH = bmr_thresh_Light,
      RNGE = 1000000,
      TrustHi = FALSE #We assume that there is more noise at the higher concentration, so if two correction sets are equal, go with the lower concentration set
      ) %>%
  summarize_rcurvep_output(inactivate = "INVERSE", ci_level = 0.95)
```


```{r 105Rcurvep_obj_wrangling, include = FALSE}
## Light_1
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Light_1P <- summarise_rcurvep_results(resp_set = Light_1_outP$result$resp_set, act_set = Light_1_outP$result$act_set, act_summary = Light_1_outP$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Light_1P <- simulated_curves_Light_1P %>%
  filter(hit == 1)

#confident_curves_Light_1P <- confident_hits(summary_dat = simulated_curves_Light_1P, reject_hit_conf_under = 0.5)

bmds_Light_1P <- simulated_curves_Light_1P %>%
  group_by(chemical) %>%
  summarise(POD_ciu = unique(ciu_POD), median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light_2
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Light_2P <- summarise_rcurvep_results(resp_set = Light_2_outP$result$resp_set, act_set = Light_2_outP$result$act_set, act_summary = Light_2_outP$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Light_2P <- simulated_curves_Light_2P %>%
  filter(hit == 1)

#confident_curves_Light_2P <- confident_hits(summary_dat = simulated_curves_Light_2P, reject_hit_conf_under = 0.5)

bmds_Light_2P <- simulated_curves_Light_2P %>%
  group_by(chemical) %>%
  summarise(POD_ciu = unique(ciu_POD), median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light_3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Light_3P <- summarise_rcurvep_results(resp_set = Light_3_outP$result$resp_set, act_set = Light_3_outP$result$act_set, act_summary = Light_3_outP$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Light_3P <- simulated_curves_Light_3P %>%
  filter(hit == 1)

#confident_curves_Light_3P <- confident_hits(summary_dat = simulated_curves_Light_3P, reject_hit_conf_under = 0.5)

bmds_Light_3P <- simulated_curves_Light_3P %>%
  group_by(chemical) %>%
  summarise(POD_ciu = unique(ciu_POD), median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#



## Dark_1
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Dark_1P <- summarise_rcurvep_results(resp_set = Dark_1_outP$result$resp_set, act_set = Dark_1_outP$result$act_set, act_summary = Dark_1_outP$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Dark_1P <- simulated_curves_Dark_1P %>%
  filter(hit == 1)

#confident_curves_Dark_1P <- confident_hits(summary_dat = simulated_curves_Dark_1P, reject_hit_conf_under = 0.5)

bmds_Dark_1P <- simulated_curves_Dark_1P %>%
  group_by(chemical) %>%
  summarise(POD_ciu = unique(ciu_POD), median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#


## Dark_2
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Dark_2P <- summarise_rcurvep_results(resp_set = Dark_2_outP$result$resp_set, act_set = Dark_2_outP$result$act_set, act_summary = Dark_2_outP$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Dark_2P <- simulated_curves_Dark_2P %>%
  filter(hit == 1)

#confident_curves_Dark_2P <- confident_hits(summary_dat = simulated_curves_Dark_2P, reject_hit_conf_under = 0.5)

bmds_Dark_2P <- simulated_curves_Dark_2P %>%
  group_by(chemical) %>%
  summarise(POD_ciu = unique(ciu_POD), median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#


## Dark_3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_Dark_3P <- summarise_rcurvep_results(resp_set = Dark_3_outP$result$resp_set, act_set = Dark_3_outP$result$act_set, act_summary = Dark_3_outP$act_summary, reject_hit_conf_under = 0.5)

curve_hits_Dark_3P <- simulated_curves_Dark_3P %>%
  filter(hit == 1)

#confident_curves_Dark_3P <- confident_hits(summary_dat = simulated_curves_Dark_3P, reject_hit_conf_under = 0.5)

bmds_Dark_3P <- simulated_curves_Dark_3P %>%
  group_by(chemical) %>%
  summarise(POD_ciu = unique(ciu_POD), median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#




## Light
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_LightP <- summarise_rcurvep_results(resp_set = Light_outP$result$resp_set, act_set = Light_outP$result$act_set, act_summary = Light_outP$act_summary, reject_hit_conf_under = 0.5)

curve_hits_LightP <- simulated_curves_LightP %>%
  filter(hit == 1)

#confident_curves_LightP <- confident_hits(summary_dat = simulated_curves_LightP, reject_hit_conf_under = 0.5)

bmds_LightP <- simulated_curves_LightP %>%
  group_by(chemical) %>%
  summarise(POD_ciu = unique(ciu_POD), median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#


## Dark
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
simulated_curves_DarkP <- summarise_rcurvep_results(resp_set = Dark_outP$result$resp_set, act_set = Dark_outP$result$act_set, act_summary = Dark_outP$act_summary, reject_hit_conf_under = 0.5)

curve_hits_DarkP <- simulated_curves_DarkP %>%
  filter(hit == 1)

#confident_curves_DarkP <- confident_hits(summary_dat = simulated_curves_DarkP, reject_hit_conf_under = 0.5)

bmds_DarkP <- simulated_curves_DarkP %>%
  group_by(chemical) %>%
  summarise(POD_ciu = unique(ciu_POD), median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

```

```{r 106curve_simulation_auc, include = FALSE}
## Light 1
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Light_1P <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Light_1P, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Light_1P, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Light_1P[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Light_1P[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Light_1P[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = bmr_thresh_Light_1P, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Light_1P, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Light_1P, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Light_1P, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Light_1P, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = simulated_curves_Light_1P, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -85, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light_2
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Light_2P <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Light_2P, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Light_2P, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Light_2P[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Light_2P[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Light_2P[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = bmr_thresh_Light_2P, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Light_2P, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Light_2P, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Light_2P, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Light_2P, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = simulated_curves_Light_2P, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -85, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light_3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Light_3P <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Light_3P, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Light_3P, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Light_3P[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Light_3P[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Light_3P[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = bmr_thresh_Light_3P, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Light_3P, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Light_3P, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Light_3P, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Light_3P, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = simulated_curves_Light_3P, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -85, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#


## Dark_1
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Dark_1P <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Dark_1P, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Dark_1P, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Dark_1P[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Dark_1P[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Dark_1P[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = bmr_thresh_Dark_1P, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Dark_1P, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Dark_1P, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Dark_1P, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Dark_1P, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = simulated_curves_Dark_1P, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -85, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark_2
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Dark_2P <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Dark_2P, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Dark_2P, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Dark_2P[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Dark_2P[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Dark_2P[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = bmr_thresh_Dark_2P, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Dark_2P, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Dark_2P, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Dark_2P, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Dark_2P, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = simulated_curves_Dark_2P, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -85, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark_3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Dark_3P <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_Dark_3P, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_Dark_3P, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_Dark_3P[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Dark_3P[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_Dark_3P[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = bmr_thresh_Dark_3P, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_Dark_3P, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_Dark_3P, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_Dark_3P, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_Dark_3P, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = simulated_curves_Dark_3P, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -85, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#


## Light
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_LightP <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_LightP, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_LightP, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_LightP[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_LightP[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_LightP[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = bmr_thresh_LightP, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_LightP, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_LightP, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_LightP, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_LightP, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = simulated_curves_LightP, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -85, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#


## Dark
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_DarkP <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = simulated_curves_DarkP, mapping = aes(x = conc, y = resp, group = sample_id), color = "gray75", alpha = 0.2) +
  geom_line(data = curve_hits_DarkP, mapping = aes(x = conc, y = resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_curves_DarkP[[1]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_DarkP[[2]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_curves_DarkP[[3]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
  geom_hline(yintercept = bmr_thresh_DarkP, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_DarkP, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_DarkP, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_DarkP, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_DarkP, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = simulated_curves_DarkP, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -85, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
```

```{r 107run_fits_auc, include=FALSE}
# Use the Normalized data as input
temp_LD <- temp_auc_norm_LD_no_cntrlP %>%
  select(endpoint, chemical, conc, resp) %>%
  group_by(chemical)



## Light_1
temp_Light_1 <- temp %>%
  filter(endpoint == "Light_1")

Light_1_fittedP <- run_fit(
  create_dataset(d = temp_Light_1, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = 1
)

## Light_2
temp_Light_2 <- temp %>%
  filter(endpoint == "Light_2")

Light_2_fittedP <- run_fit(
  create_dataset(d = temp_Light_2, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = 1
)
## Light_3
temp_Light_3 <- temp %>%
  filter(endpoint == "Light_3")

Light_3_fittedP <- run_fit(
  create_dataset(d = temp_Light_3, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = 1
)

## Dark_1
temp_Dark_1 <- temp %>%
  filter(endpoint == "Dark_1")

Dark_1_fittedP <- run_fit(
  create_dataset(d = temp_Dark_1, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = 1
)

## Dark_2
temp_Dark_2 <- temp %>%
  filter(endpoint == "Dark_2")

Dark_2_fittedP <- run_fit(
  create_dataset(d = temp_Dark_2, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = 1
)

## Dark_3
temp_Dark_3 <- temp %>%
  filter(endpoint == "Dark_3")

Dark_3_fittedP <- run_fit(
  create_dataset(d = temp_Dark_3, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = 1
)

## Light
temp_Light <- temp_LD %>%
  filter(endpoint == "Light")

Light_fittedP <- run_fit(
  create_dataset(d = temp_Light, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = 1
)
## Dark
temp_Dark <- temp_LD %>%
  filter(endpoint == "Dark")

Dark_fittedP <- run_fit(
  create_dataset(d = temp_Dark, n_samples = params$sample_size),
  modls = c("hill", "cnst"),
  keep_sets = c("fit_set", "resp_set"),
  n_samples = params$sample_size,
  hill_pdir = 1
)
```

```{r 108wrangling_fitted_auc_data, include=FALSE}
#Wrangling

## Light_1
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
Light_1_fitted_outputP <- summarize_fit_output(d = Light_1_fittedP, thr_resp = bmr_thresh_Light_1P)

Light_1_fitted_output_summaryP <- summarise_fitted_results(resp_set = Light_1_fitted_outputP$result$resp_set, act_set = Light_1_fitted_outputP$result$act_set, act_summary = Light_1_fitted_outputP$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Light_1P <- Light_1_fitted_output_summaryP %>%
  filter(hit == 1)

#confident_fitted_hits_Light_1P <- confident_hits(summary_dat = Light_1_fitted_output_summaryP, reject_hit_conf_under = 0.5)

bmds_fitted_Light_1P <- Light_1_fitted_output_summaryP %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light_2
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
Light_2_fitted_outputP <- summarize_fit_output(d = Light_2_fittedP, thr_resp = bmr_thresh_Light_2P)

Light_2_fitted_output_summaryP <- summarise_fitted_results(resp_set = Light_2_fitted_outputP$result$resp_set, act_set = Light_2_fitted_outputP$result$act_set, act_summary = Light_2_fitted_outputP$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Light_2P <- Light_2_fitted_output_summaryP %>%
  filter(hit == 1)

#confident_fitted_hits_Light_2P <- confident_hits(summary_dat = Light_2_fitted_output_summaryP, reject_hit_conf_under = 0.5)

bmds_fitted_Light_2P <- Light_2_fitted_output_summaryP %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light_3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
Light_3_fitted_outputP <- summarize_fit_output(d = Light_3_fittedP, thr_resp = bmr_thresh_Light_3P)

Light_3_fitted_output_summaryP <- summarise_fitted_results(resp_set = Light_3_fitted_outputP$result$resp_set, act_set = Light_3_fitted_outputP$result$act_set, act_summary = Light_3_fitted_outputP$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Light_3P <- Light_3_fitted_output_summaryP %>%
  filter(hit == 1)

#confident_fitted_hits_Light_3P <- confident_hits(summary_dat = Light_3_fitted_output_summaryP, reject_hit_conf_under = 0.5)

bmds_fitted_Light_3P <- Light_3_fitted_output_summaryP %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark_1
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
Dark_1_fitted_outputP <- summarize_fit_output(d = Dark_1_fittedP, thr_resp = bmr_thresh_Dark_1P)

Dark_1_fitted_output_summaryP <- summarise_fitted_results(resp_set = Dark_1_fitted_outputP$result$resp_set, act_set = Dark_1_fitted_outputP$result$act_set, act_summary = Dark_1_fitted_outputP$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Dark_1P <- Dark_1_fitted_output_summaryP %>%
  filter(hit == 1)

#confident_fitted_hits_Dark_1P <- confident_hits(summary_dat = Dark_1_fitted_output_summaryP, reject_hit_conf_under = 0.5)

bmds_fitted_Dark_1P <- Dark_1_fitted_output_summaryP %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark_2
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
Dark_2_fitted_outputP <- summarize_fit_output(d = Dark_2_fittedP, thr_resp = bmr_thresh_Dark_2P)

Dark_2_fitted_output_summaryP <- summarise_fitted_results(resp_set = Dark_2_fitted_outputP$result$resp_set, act_set = Dark_2_fitted_outputP$result$act_set, act_summary = Dark_2_fitted_outputP$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Dark_2P <- Dark_2_fitted_output_summaryP %>%
  filter(hit == 1)

#confident_fitted_hits_Dark_2P <- confident_hits(summary_dat = Dark_2_fitted_output_summaryP, reject_hit_conf_under = 0.5)

bmds_fitted_Dark_2P <- Dark_2_fitted_output_summaryP %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark_3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
Dark_3_fitted_outputP <- summarize_fit_output(d = Dark_3_fittedP, thr_resp = bmr_thresh_Dark_3P)

Dark_3_fitted_output_summaryP <- summarise_fitted_results(resp_set = Dark_3_fitted_outputP$result$resp_set, act_set = Dark_3_fitted_outputP$result$act_set, act_summary = Dark_3_fitted_outputP$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_Dark_3P <- Dark_3_fitted_output_summaryP %>%
  filter(hit == 1)

#confident_fitted_hits_Dark_3P <- confident_hits(summary_dat = Dark_3_fitted_output_summaryP, reject_hit_conf_under = 0.5)

bmds_fitted_Dark_3P <- Dark_3_fitted_output_summaryP %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
Light_fitted_outputP <- summarize_fit_output(d = Light_fittedP, thr_resp = bmr_thresh_LightP)

Light_fitted_output_summaryP <- summarise_fitted_results(resp_set = Light_fitted_outputP$result$resp_set, act_set = Light_fitted_outputP$result$act_set, act_summary = Light_fitted_outputP$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_LightP <- Light_fitted_output_summaryP %>%
  filter(hit == 1)

#confident_fitted_hits_LightP <- confident_hits(summary_dat = Light_fitted_output_summaryP, reject_hit_conf_under = 0.5)

bmds_fitted_LightP <- Light_fitted_output_summaryP %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
Dark_fitted_outputP <- summarize_fit_output(d = Dark_fittedP, thr_resp = bmr_thresh_DarkP)

Dark_fitted_output_summaryP <- summarise_fitted_results(resp_set = Dark_fitted_outputP$result$resp_set, act_set = Dark_fitted_outputP$result$act_set, act_summary = Dark_fitted_outputP$act_summary, reject_hit_conf_under = 0.5)

fitted_hits_DarkP <- Dark_fitted_output_summaryP %>%
  filter(hit == 1)

#confident_fitted_hits_DarkP <- confident_hits(summary_dat = Dark_fitted_output_summaryP, reject_hit_conf_under = 0.5)

bmds_fitted_DarkP <- Dark_fitted_output_summaryP %>%
  group_by(chemical) %>%
  summarise(median_POD = unique(median_POD), POD_cil = unique(POD_cil), mean_POD = unique(mean_POD), POD_med = unique(POD_med), POD_ciu = unique(POD_ciu), hit_confidence = unique(hit_confidence), lowest_conc = unique(lowest_conc), highest_conc = unique(highest_conc))
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
```


```{r 109plot_fitted_aucs, include=FALSE}
#Plotting

## Light_1
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Light_1_fittedP <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Light_1_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Light_1_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Light_1P, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Light_1P[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Light_1P[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Light_1P[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  # geom_hline(yintercept = -bmr_thresh_Light_1P, linetype = "dashed", color = "red") +
  geom_hline(yintercept = bmr_thresh_Light_1P, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Light_1P, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Light_1P, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Light_1P, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Light_1, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Light_1_fitted_output_summaryP, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -60, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light_2
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Light_2_fittedP <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Light_2_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Light_2_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Light_2P, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Light_2P[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Light_2P[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Light_2P[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  # geom_hline(yintercept = -bmr_thresh_Light_2P, linetype = "dashed", color = "red") +
  geom_hline(yintercept = bmr_thresh_Light_2P, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Light_2P, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Light_2P, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Light_2P, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Light_2, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Light_2_fitted_output_summaryP, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -60, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light_3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Light_3_fittedP <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Light_3_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Light_3_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Light_3P, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Light_3P[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Light_3P[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Light_3P[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  # geom_hline(yintercept = -bmr_thresh_Light_3P, linetype = "dashed", color = "red") +
  geom_hline(yintercept = bmr_thresh_Light_3P, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Light_3P, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Light_3P, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Light_3P, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Light_3P, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Light_3_fitted_output_summaryP, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -60, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark_1
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Dark_1_fittedP <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Dark_1_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Dark_1_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Dark_1P, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Dark_1P[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Dark_1P[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Dark_1P[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  # geom_hline(yintercept = -bmr_thresh_Dark_1P, linetype = "dashed", color = "red") +
  geom_hline(yintercept = bmr_thresh_Dark_1P, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Dark_1P, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Dark_1P, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Dark_1P, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Dark_1P, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Dark_1_fitted_output_summaryP, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -60, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark_2
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Dark_2_fittedP <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Dark_2_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Dark_2_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Dark_2P, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Dark_2P[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Dark_2P[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Dark_2P[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  # geom_hline(yintercept = -bmr_thresh_Dark_2P, linetype = "dashed", color = "red") +
  geom_hline(yintercept = bmr_thresh_Dark_2P, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Dark_2P, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Dark_2P, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Dark_2P, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Dark_2P, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Dark_2_fitted_output_summaryP, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -60, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark_3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Dark_3_fittedP <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Dark_3_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Dark_3_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_Dark_3P, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_Dark_3P[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_Dark_3P[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_Dark_3P[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  # geom_hline(yintercept = -bmr_thresh_Dark_3P, linetype = "dashed", color = "red") +
   geom_hline(yintercept = bmr_thresh_Dark_3P, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_Dark_3P, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_Dark_3P, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_Dark_3P, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_Dark_3, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Dark_3_fitted_output_summaryP, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -60, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100, 50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Light
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Light_fittedP <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Light_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Light_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_LightP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_LightP[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_LightP[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_LightP[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  # geom_hline(yintercept = -bmr_thresh_LightP, linetype = "dashed", color = "red") +
  geom_hline(yintercept = bmr_thresh_LightP, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_LightP, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_LightP, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_LightP, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_LightP, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Light_fitted_output_summaryP, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -60, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

## Dark
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#
p_Dark_fittedP <- ggplot(NULL, aes(conc, resp)) +
  geom_line(data = Dark_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "gray75", alpha = 0.4) +
  # geom_point(data = Dark_fitted_output_summaryP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9", alpha = 0.7) +
  geom_line(data = fitted_hits_DarkP, mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "#a9a9a9",  alpha = 0.7) +
  # geom_line(data = confident_fitted_hits_DarkP[[1]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "green") +
  # geom_line(data = confident_fitted_hits_DarkP[[2]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "yellow") +
  # geom_line(data = confident_fitted_hits_DarkP[[3]], mapping = aes(x = conc, y = fitted_resp, group = sample_id), color = "blue") +
  # geom_hline(yintercept = -bmr_thresh_DarkP, linetype = "dashed", color = "red") +
  geom_hline(yintercept = bmr_thresh_DarkP, linetype = "dashed", color = "red") +
  geom_vline(data = bmds_fitted_DarkP, aes(xintercept = median_POD), color = "blue") +
  # geom_vline(data = bmds_fitted_DarkP, aes(xintercept = POD_med), color = "yellow") +
  # geom_vline(data = bmds_fitted_DarkP, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_fitted_DarkP, aes(xintercept = POD_cil), color = "purple") +
  geom_text(data = Dark_fitted_output_summaryP, mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc+1), y = -60, inherit.aes = FALSE, size = 4) +
  facet_wrap(~chemical, scales = "free_x") +
  ylim(-100,50) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey50", fill = NA), panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

```





```{r 110List_auc_plot, include=FALSE}
p_list_2 <-
  list(
    p_Dark,
    p_DarkP,
    p_Dark_1,
    p_Dark_1P,
    p_Dark_2,
    p_Dark_2P,
    p_Dark_3,
    p_Dark_3P,
    p_Light,
    p_LightP,
    p_Light_1,
    p_Light_1P,
    p_Light_2,
    p_Light_2P,
    p_Light_3,
    p_Light_3P
  )
p_list_3 <-
  list(
    p_Dark_fitted,
    p_Dark_fittedP,
    p_Dark_1_fitted,
    p_Dark_1_fittedP,
    p_Dark_2_fitted,
    p_Dark_2_fittedP,
    p_Dark_3_fitted,
    p_Dark_3_fittedP,
    p_Light_fitted,
    p_Light_fittedP,
    p_Light_1_fitted,
    p_Light_1_fittedP,
    p_Light_2_fitted,
    p_Light_2_fittedP,
    p_Light_3_fitted,
    p_Light_3_fittedP
  )
names(p_list_2) <-
  c(
    "Dark cycles (all 3) - Negative direction rucrvep",
    "Dark cycles (all 3) - Positive direction rucrvep",
    "Dark cycle 1 (5 mins) - Negative direction rcurvep",
    "Dark cycle 1 (5 mins) - Positive direction rcurvep",
    "Dark cycle 2 (5 mins) - Negative rcurvep",
    "Dark cycle 2 (5 mins) - Positive rcurvep",
    "Dark cycle 3 (5 mins) - Negative rcurvep",
    "Dark cycle 3 (5 mins) - Positive rcurvep",
    "Light cycles (all 3) - Negative rucrvep",
    "Light cycles (all 3) - Positive rucrvep",
    "Light cycle 1 (5 mins) - Negative rcurvep",
    "Light cycle 1 (5 mins) - Positive rcurvep",
    "Light cycle 2 (5 mins) - Negative rcurvep",
    "Light cycle 2 (5 mins) - Positive rcurvep",
    "Light cycle 3 (5 mins) - Negative rcurvep",
    "Light cycle 3 (5 mins) - Positive rcurvep"
  )
names(p_list_3) <-
  c(
    "Dark cycles (all 3) - Negative Direction fitted",
    "Dark cycles (all 3) - Positive Direction fitted",
    "Dark cycle 1 (5 mins) - Negative fitted",
    "Dark cycle 1 (5 mins) - Positive fitted",
    "Dark cycle 2 (5 mins) - Negative fitted",
    "Dark cycle 2 (5 mins) - Positive fitted",
    "Dark cycle 3 (5 mins) - Negative fitted",
    "Dark cycle 3 (5 mins) - Positive fitted",
    "Light cycles (all 3) - Negative fitted",
    "Light cycles (all 3) - Positive fitted",
    "Light cycle 1 (5 mins) - Negative fitted",
    "Light cycle 1 (5 mins) - Positive fitted",
    "Light cycle 2 (5 mins) - Negative fitted",
    "Light cycle 2 (5 mins) - Positive itted",
    "Light cycle 3 (5 mins) - Negative fitted",
    "Light cycle 3 (5 mins) - Positive fitted"
  )
```


#### Simulated Curve Plots with median BMDs (Blue), mean BMDs (Green), and the RcurveP BMDs (Yellow) {.tabset}
```{r 111Simulated_curves, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
for (i in seq_along(p_list_2)){
  temp <- p_list_2[[i]]
  cat("#####", names(p_list_2)[i], " \n")
  print(temp)
  cat(' \n\n')
}
```

#### {-}

## _

#### Fitted Curve Plots with median BMDs (Blue), mean BMDs (Green), and the RcurveP BMDs (Yellow) {.tabset}
```{r 112Simulated_curves, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
for (i in seq_along(p_list_3)){
  temp <- p_list_3[[i]]
  cat("#####", names(p_list_3)[i], " \n")
  print(temp)
  cat(' \n\n')
}
```

#### {-}

```{r 113_Summarry_of_BMDs_All_Endpoints, echo=FALSE}
temp_list <-
  list(
    bmds_pearson,
    bmds_spearman,
    bmds_fitted_pearson,
    bmds_fitted_spearman,
    bmds_Dark,
    bmds_DarkP,
    bmds_Dark_1,
    bmds_Dark_1P,
    bmds_Dark_2,
    bmds_Dark_2P,
    bmds_Dark_3,
    bmds_Dark_3P,
    bmds_Light,
    bmds_LightP,
    bmds_Light_1,
    bmds_Light_1P,
    bmds_Light_2,
    bmds_Light_2P,
    bmds_Light_3,
    bmds_Light_3P,
    bmds_fitted_Dark,
    bmds_fitted_DarkP,
    bmds_fitted_Dark_1,
    bmds_fitted_Dark_1P,
    bmds_fitted_Dark_2,
    bmds_fitted_Dark_2P,
    bmds_fitted_Dark_3,
    bmds_fitted_Dark_3P,
    bmds_fitted_Light,
    bmds_fitted_LightP,
    bmds_fitted_Light_1,
    bmds_fitted_Light_1P,
    bmds_fitted_Light_2,
    bmds_fitted_Light_2P,
    bmds_fitted_Light_3,
    bmds_fitted_Light_3P
  )
names(temp_list) <-
  c("rcurvep_pearson",
    "rcurvep_spearman",
    "fitted_pearson",
    "fitted_spearman",
    "Dark cycles (all 3) - Negative direction rucrvep",
    "Dark cycles (all 3) - Positive direction rucrvep",
    "Dark cycle 1 - Negative direction rcurvep",
    "Dark cycle 1 - Positive direction rcurvep",
    "Dark cycle 2 - Negative rcurvep",
    "Dark cycle 2 - Positive rcurvep",
    "Dark cycle 3 - Negative rcurvep",
    "Dark cycle 3 - Positive rcurvep",
    "Light cycles (all 3) - Negative rucrvep",
    "Light cycles (all 3) - Positive rucrvep",
    "Light cycle 1 - Negative rcurvep",
    "Light cycle 1 - Positive rcurvep",
    "Light cycle 2 - Negative rcurvep",
    "Light cycle 2 - Positive rcurvep",
    "Light cycle 3 - Negative rcurvep",
    "Light cycle 3 - Positive rcurvep",
    "Dark cycles (all 3) - Negative Direction fitted",
    "Dark cycles (all 3) - Positive Direction fitted",
    "Dark cycle 1 - Negative fitted",
    "Dark cycle 1 - Positive fitted",
    "Dark cycle 2 - Negative fitted",
    "Dark cycle 2 - Positive fitted",
    "Dark cycle 3 - Negative fitted",
    "Dark cycle 3 - Positive fitted",
    "Light cycles (all 3) - Negative fitted",
    "Light cycles (all 3) - Positive fitted",
    "Light cycle 1 - Negative fitted",
    "Light cycle 1 - Positive fitted",
    "Light cycle 2 - Negative fitted",
    "Light cycle 2 - Positive itted",
    "Light cycle 3 - Negative fitted",
    "Light cycle 3 - Positive fitted"
    )
all_summarized_bmd_dat <- ldply(temp_list)
all_summarized_bmd_dat <- all_summarized_bmd_dat %>%
  arrange(chemical)

all_summarized_bmd_dat %>%
  mutate(
    lowest_conc = 10 ^ (lowest_conc),
    highest_conc = sprintf((10 ^ (highest_conc)), fmt = '%.7f'),
    cil_POD = 10 ^ (cil_POD),
    POD_med = 10 ^ (POD_med),
    ciu_POD = 10 ^ (ciu_POD)
  ) %>%
  select(chemical,
         .id,
         lowest_conc,
         highest_conc,
         cil_POD,
         POD_med,
         ciu_POD,
         hit_confidence) %>%
  datatable(
    colnames = c(
      "Chemical",
      "endpoint",
      "Low Dose",
      "High Dose",
      "BMD - low confidence interval (0.05)",
      "BMD",
      "BMD - high confidence interval (0.95)",
      "Hit Confidence"
    ),
    caption = "Table 9. Summary of all the benchmark doses (BMDs) of every chemical"
  )
```


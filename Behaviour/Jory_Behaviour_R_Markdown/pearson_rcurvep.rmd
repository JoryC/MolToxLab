---
title: "Report for `r params$endpoint` using the `r params$method` method (`r params$sample_size` samples)"
author: "Jory Curry"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    code_folding: show
    df_print: paged
    toc: true
    toc_depth: 5
    toc_float: true
    theme: readable
params:
  value: "value"
  sample_size: "sample_size"
  endpoint: "pearson"
  method: "rcurvep"
---

```{r 1setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
options(scipen = 9)
```

```{r 2libraries, include=FALSE}
library(knitr)
library(kableExtra)
library(gridExtra)
library(rlang)
library(Rcurvep)
library(DescTools)
library(data.table)
library(car)
library(lazyeval)
library(DT)
library(here)
library(future) 
library(future.apply) # from original future author
library(furrr) # use future.apply but similar to purrr package
library(tidyverse)
future::plan(multisession, workers = availableCores()) # windows, Mac needs multicore
source("Functions/cal_auc_simi_endpoints.R")
source("Functions/behavioural_endpoint_calc.R")
source("Functions/RCurveP_Data_Wrangling_Functions.R")
```



# Toxicology Behavioural Analysis Report

## Version Control
```{r 3version_control, comment="", class.source ='fold-hide'}
# - My Machine Info:
#   - R version 4.2.1 (2022-06-23)
#   - Platform: x86_64-pc-linux-gnu (64-bit)         5.11.0-34-generic / Ubuntu 22.04.1 LTS
#   - Desktop: GNOME 3.36.5
#   - Hardware: CPU - Intel Core i5-9400F 6 core 4.1GHz / RAM - 15924MiB
```


```{r 8directory, include=FALSE}
dir <- paste0(getwd(), "/Data/All")
```

```{r 9directory_files_filenames, include=FALSE}
fileNames <- list.files("Data/Raw") #Get the name of each .csv file
chemicalNames <- str_split(string = fileNames, pattern = ".csv", simplify = TRUE)[,1] #Identify the chemicals included in the files
metaData <- read.csv(file = "Data/MetaData.csv") #Import the Meta Data that includes information about the data in the folders
#CAS is the Chemical Abstract Service, MOA is the Mode of Action. This table includes useful information about the exposure concentrations for each chemical dose in mg/L. We'll use this later to create our final data frame
#HighDose <- setNames(metaData[,6], chemicalNames) #subsetting metadata
doseData <- metaData %>%
  select(plate_id, Dose1:Control) %>%
  gather(key = Dose, value = "Dose_mg_L", Dose1:Control)
number_of_dose_groups_per_chem <- 6 # Set this to the number of dose groups you have (including control)
lowest_dose_treatment_group <- doseData %>%
    filter(Dose != "Control") %>%
    dplyr::summarize(lowest_dose_treatment_group = min(Dose_mg_L))
lowest_dose_treatment_group <- lowest_dose_treatment_group[1,][[1]]
simi_norm_tib_4rcurvep_pearson <- readRDS(file = paste0("Data/", "simi_norm_tib_4rcurvep_pearson.rds"))
input_pearson_tib <- readRDS(file = paste0("Data/", "input_pearson_tib.rds"))
bmr_thresh_pearson <- readRDS(file = paste0("Data/", "pearson_rcurvepBMR.rds"))
```


## Similarity Scores/Correlation coefficients

### Benchmark Dose

Since we do not know what the benchmark response is for each one of the chemicals, a method will be used that can estimate a benchmark response (empirically) when given a large enough set of data. The RcurveP package includes an automated process to select an appropriate BMR based off of the data. From Hsieh et al. 2019 manuscript: "The pooled variance of potency of all chemicals per [threshold value (i.e. 5 through 99)] was calculated. The BMR was considered as the [threshold value] at which the potency variance was sufficiently reduced and was the lowest threshold that potency variance was stabilized". AKA, "the lowest threshold (which gives the highest potency), at which a decrease of variance in potency estimation is stabilized"

#### Negative Direction

```{r 60calculating_benchmark_dose, include = FALSE, warning=FALSE, message=FALSE}
system.time(
  bmd_dat_nobin_neg_pearson <-
    future_pmap(
      input_pearson_tib,
      ~ combi_run_rcurvep(
        ..4,
        TRSH = ..3,
        RNGE = ..1,
        n_samples = params$sample_size,
        keep_sets = c("act_set", "resp_set"),
        TrustHi = FALSE
      ),
      .options = furrr_options(seed = 42069)
    )
)
```

```{r 61calculating_benchmark_dose_2, echo=FALSE, collapse=TRUE, warning=FALSE}
sum_bmd_dat_nobin_neg_pearson <-
  summarize_rcurvep_output(
    bmd_dat_nobin_neg_pearson[[1]],
    inactivate = "INVERSE",
    ci_level = 0.95
  )
```


```{r ClearMemory, include=FALSE}
rm(bmd_dat_nobin_neg_pearson, input_pearson_tib)
gc()
```




```{r 61.1simulated_curveps, include = FALSE, warning=FALSE}

#pearson Negative Direction RCurveP - Entire code chunk is for 'Not binned' data
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

simulated_curves_pearson_summary <-
  summarise_rcurvep_results(
    resp_set = sum_bmd_dat_nobin_neg_pearson$result$resp_set,
    act_set = sum_bmd_dat_nobin_neg_pearson$result$act_set,
    act_summary = sum_bmd_dat_nobin_neg_pearson$act_summary,
    reject_hit_conf_under = 0.01
  )

bmds_pearson <- bmd_results(simulated_curves_pearson_summary)

curve_hits_pearson <- simulated_curves_pearson_summary %>%
  filter(hit == 1)

#confident_curves_pearson <- confident_hits(summary_dat = simulated_curves_pearson_summary, reject_hit_conf_under = 0.5)
# If Error says "out of bounds", reduce conf filter

#Data Wrangling for nice labels
simulated_curves_pearson_summary <- simulated_curves_pearson_summary %>%
  group_by(chemical) %>%
  mutate(x_label_num = if_else(condition = conc == lowest_conc, true = 0, false = (10^conc)*lowest_dose_treatment_group)) %>%
  mutate(x_label = factor(x_label_num, levels = c(0, lowest_dose_treatment_group, lowest_dose_treatment_group*10, lowest_dose_treatment_group*100, lowest_dose_treatment_group*1000, lowest_dose_treatment_group*10000, lowest_dose_treatment_group*100000, lowest_dose_treatment_group*1000000, lowest_dose_treatment_group*10000000, lowest_dose_treatment_group*100000000, lowest_dose_treatment_group*1000000000, lowest_dose_treatment_group*10000000000), ordered = TRUE))

curve_hits_pearson <- curve_hits_pearson %>%
  group_by(chemical) %>%
  mutate(x_label_num = if_else(condition = conc == lowest_conc, true = 0, false = (10^conc)*lowest_dose_treatment_group)) %>%
  mutate(x_label = factor(x_label_num, levels = c(0, lowest_dose_treatment_group, lowest_dose_treatment_group*10, lowest_dose_treatment_group*100, lowest_dose_treatment_group*1000, lowest_dose_treatment_group*10000, lowest_dose_treatment_group*100000, lowest_dose_treatment_group*1000000, lowest_dose_treatment_group*10000000, lowest_dose_treatment_group*100000000, lowest_dose_treatment_group*1000000000, lowest_dose_treatment_group*10000000000), ordered = TRUE))

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

p_pearson_simulated_no_processing <- ggplot(NULL, aes(x_label, resp)) +
  geom_point(
    data = simulated_curves_pearson_summary,
    mapping = aes(x = x_label, y  = resp, group = sample_id),
    color = "gray75",
    alpha = 0.7
  ) +
  # geom_point(
  #   data = curve_hits_pearson,
  #   mapping = aes(x = x_label, y = resp, group = sample_id),
  #   color = "#a9a9a9",
  #   alpha = 0.7
  # ) +
  geom_line(
    data = simulated_curves_pearson_summary,
    mapping = aes(x = x_label, y = resp, group = sample_id),
    color = "gray75",
    alpha = 0.7
  ) +
  # geom_line(
  #   data = curve_hits_pearson,
  #   mapping = aes(x = x_label, y = resp, group = sample_id),
  #   color = "#a9a9a9",
  #   alpha = 0.7
  # ) +
  # geom_hline(
  #   yintercept = -bmr_thresh_pearson,
  #   linetype = "dashed",
  #   color = "red"
  # ) +
  # geom_vline(data = bmds_pearson,
  #            aes(xintercept = median_POD),
  #            color = "blue") +
  # geom_vline(data = bmds_pearson, aes(xintercept = ciu_POD), color = "yellow") +
  # geom_vline(data = bmds_pearson, aes(xintercept = mean_POD), color = "green") +
  # geom_vline(data = bmds_pearson, aes(xintercept = cil_POD), color = "purple") +
  # geom_text(
  #   data = bmds_pearson,
  #   mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc +
  #                   1),
  #   y = 85,
  #   inherit.aes = FALSE,
  #   size = 4
  # ) +
  facet_wrap( ~ chemical, scales = "free") +
  ylim(-100, 50) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "grey50", fill = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  scale_y_continuous(limits = c(-100,100), breaks = seq(from = -100, to = 100, by = 25)) +
  xlab("Dose (mg/L)") +
  ylab(paste0("Normalized ", params$endpoint, "'s", " r similarity score"))

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

# p_pearson <- ggplot(NULL, aes(conc, resp)) +
#   geom_point(
#     data = simulated_curves_pearson_summary,
#     mapping = aes(x = conc, y  = corrected_resp, group = sample_id),
#     color = "gray75",
#     alpha = 0.2
#   ) +
#   geom_point(
#     data = curve_hits_pearson,
#     mapping = aes(x = conc, y = corrected_resp, group = sample_id),
#     color = "#a9a9a9",
#     alpha = 0.7
#   ) +
#   geom_line(
#     data = simulated_curves_pearson_summary,
#     mapping = aes(x = conc, y = corrected_resp, group = sample_id),
#     color = "gray75",
#     alpha = 0.2
#   ) +
#   geom_line(
#     data = curve_hits_pearson,
#     mapping = aes(x = conc, y = corrected_resp, group = sample_id),
#     color = "#a9a9a9",
#     alpha = 0.7
#   ) +
#   # geom_line(data = confident_curves_pearson[["cil"]], mapping = aes(x = conc, y = resp, group = sample_id), color = "purple") +
#   # geom_line(data = confident_curves_pearson[["ciu"]], mapping = aes(x = conc, y = resp, group = sample_id), color = "yellow") +
#   # geom_line(data = confident_curves_pearson[["mean"]], mapping = aes(x = conc, y = resp, group = sample_id), color = "green") +
#   # geom_line(data = confident_curves_pearson[["median"]], mapping = aes(x = conc, y = resp, group = sample_id), color = "blue") +
#   geom_hline(
#     yintercept = -bmr_thresh_pearson,
#     linetype = "dashed",
#     color = "red"
#   ) +
#   geom_vline(data = bmds_pearson,
#              aes(xintercept = median_POD),
#              color = "blue") +
#   geom_vline(data = bmds_pearson, aes(xintercept = ciu_POD), color = "yellow") +
#   # geom_vline(data = bmds_pearson, aes(xintercept = mean_POD), color = "green") +
#   geom_vline(data = bmds_pearson, aes(xintercept = cil_POD), color = "purple") +
#   geom_text(
#     data = bmds_pearson,
#     mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc +
#                     1),
#     y = -85,
#     inherit.aes = FALSE,
#     size = 4
#   ) +
#   facet_wrap( ~ chemical, scales = "free_x") +
#   ylim(-100, 0) +
#   theme_minimal() +
#   theme(
#     panel.border = element_rect(colour = "grey50", fill = NA),
#     #panel.grid.major = element_blank(),
#     panel.grid.minor = element_blank()
#   ) +
#   xlab("Dose (mg/L)") +
#   ylab("(Normalized ", paste0(params$endpoint), "'s", " r similarity score", ")")

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#

```

```{r processed_results_No_facet, echo=FALSE, warning=FALSE, message=FALSE}
options(scipen2 = 3)
print.numeric <- function(x, ...) {
  scipen2 <- getOption("scipen2", default = 3)
  ifelse(abs(log(x, 10L)) >= scipen2,
               format(x, digits = 5, scientific = TRUE),
               x)
}
chemicalNames <- unique(simulated_curves_pearson_summary$chemical)
p_list <- list()
for (k in 1:length(chemicalNames)) {
  labels <- simulated_curves_pearson_summary %>%
    filter(chemical == chemicalNames[k]) %>%
    select(x_label_num) %>%
    pull() %>%
    unique() %>%
    print.numeric()
  temp_simulated <- simulated_curves_pearson_summary %>%
    filter(chemical == chemicalNames[k])
  temp_curve_hits <- curve_hits_pearson %>%
    filter(chemical == chemicalNames[k])
  temp_bmds <- bmds_pearson %>%
    filter(chemical == chemicalNames[k])
  
  p <- ggplot() + 
    geom_point(
    data = temp_simulated,
    mapping = aes(x = conc, y = corrected_resp, group = sample_id),
    color = "gray75",
    alpha = 0.2
  ) +
  geom_point(
    data = temp_curve_hits,
    mapping = aes(x = conc, y = corrected_resp, group = sample_id),
    color = "#a9a9a9",
    alpha = 0.7
  ) +
  geom_line(
    data = temp_simulated,
    mapping = aes(x = conc, y = corrected_resp, group = sample_id),
    color = "gray75",
    alpha = 0.2
  ) +
  geom_line(
    data = temp_curve_hits,
    mapping = aes(x = conc, y = corrected_resp, group = sample_id),
    color = "#a9a9a9",
    alpha = 0.9
  ) +
  geom_hline(
    yintercept = -bmr_thresh_pearson,
    linetype = "dashed",
    color = "red"
  ) +
  # geom_vline(data = bmds,
  #            aes(xintercept = POD_med),
  #            color = "green") +
  {if(temp_bmds$ciu_POD != temp_bmds$highest_conc)geom_vline(data = temp_bmds, aes(xintercept = ciu_POD), color = "black")} +
  # geom_vline(data = bmds_pearson, aes(xintercept = mean_POD), color = "green") +
  {if(temp_bmds$cil_POD != temp_bmds$highest_conc)geom_vline(data = temp_bmds, aes(xintercept = cil_POD), color = "black")} +
     {if(temp_bmds$median_POD != temp_bmds$highest_conc)geom_vline(data = temp_bmds,
             aes(xintercept = median_POD),
             color = "blue")} +
  geom_text(
    data = temp_bmds,
    mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc),
    position = position_nudge(x = 1),
    y = -85,
    inherit.aes = FALSE,
    size = 4
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "grey50", fill = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title.x=element_blank(),
    axis.title.y=element_blank()
  ) +
  scale_y_continuous(limits = c(-100,0), breaks = seq(from = -100, to = 0, by = 20)) +
  scale_x_continuous(breaks = unique(temp_simulated$conc), labels = labels) +
  # xlab("Dose (mg/L)") +
  # ylab("Corrected Affected Rate") +
  ggtitle(paste0(chemicalNames[k]))
  
  p_list[[chemicalNames[k]]] <- list(p, chemicalNames[k])
}
```


```{r 61.2Print_results, echo=FALSE, fig.height=10.8, fig.width=19.2}
print(p_pearson_simulated_no_processing)
```

```{r alternative_save_the_resutls, include=FALSE}
yleft <-
  grid::textGrob(paste0("Normalized ", params$endpoint, "'s", " r similarity score"),
           rot = 90,
           gp = grid::gpar(fontsize = 12))
bottom <- grid::textGrob("Dose (mg/L)", gp = grid::gpar(fontsize = 12))
p <- gridExtra::grid.arrange(
  p_list[[1]][[1]],
  p_list[[2]][[1]],
  p_list[[3]][[1]],
  p_list[[4]][[1]],
  p_list[[5]][[1]],
  p_list[[6]][[1]],
  p_list[[7]][[1]],
  p_list[[8]][[1]],
  p_list[[9]][[1]],
  p_list[[10]][[1]],
  p_list[[11]][[1]],
  p_list[[12]][[1]],
  p_list[[13]][[1]],
  p_list[[14]][[1]],
  p_list[[15]][[1]],
  p_list[[16]][[1]],
  p_list[[17]][[1]],
  p_list[[18]][[1]],
  p_list[[19]][[1]],
  p_list[[20]][[1]],
  p_list[[21]][[1]],
  p_list[[22]][[1]],
  p_list[[23]][[1]],
  p_list[[24]][[1]],
  p_list[[25]][[1]],
  p_list[[26]][[1]],
  p_list[[27]][[1]],
  p_list[[28]][[1]],
  p_list[[29]][[1]],
  ncol = 6,
  nrow = 5,
  left = yleft,
  bottom = bottom
)

#save the image
ggsave(
  plot = p,
  filename = paste0(
    "Output/Images/", params$endpoint, "_", params$method, "_processed_curves_",
    params$sample_size,
    "_samples.png"
  ),
  device = "png",
  units = "px",
  width = 1920,
  height = 1080,
  bg = "white",
  scale = 3
)
```

```{r save_plots, include=FALSE}
# ggsave(
#   plot = p_pearson,
#   filename = paste0(
#     "Output/", params$endpoint, "_", params$method, "_processed_curves_",
#     params$sample_size,
#     "_samples.png"
#   ),
#   device = "png",
#   units = "px",
#   width = 1920,
#   height = 1080,
#   bg = "white",
#   scale = 2
# )

ggsave(
  plot = p_pearson_simulated_no_processing,
  filename = paste0(
    "Output/", params$endpoint, "_", params$method, "_simulated_curves_",
    params$sample_size,
    "_samples.png"
  ),
  device = "png",
  units = "px",
  width = 1920,
  height = 1080,
  bg = "white",
  scale = 2
)
```

```{r alternative_print_image, echo=FALSE}
knitr::include_graphics(
  paste0(
    "Output/Images/",
    params$endpoint,
    "_",
    params$method,
    "_processed_curves_",
    params$sample_size,
    "_samples.png"
  )
)
```

```{r 87.2Distribution_of_PODs, echo = FALSE, , fig.height=10.8, fig.width=19.2}
# p_rcurvep_pearson_distribution_bmds <- curve_hits_pearson %>%
#   group_by(chemical) %>%
#   ggplot(data = ., aes(x = POD)) +
#   geom_histogram() +
#   facet_wrap( ~ chemical, scales = "free_x") +
#   geom_vline(aes(xintercept = median_POD), color = "blue") +
#   geom_vline(aes(xintercept = cil_POD), color = "purple") +
#   geom_vline(aes(xintercept = ciu_POD), color = "yellow") +
#   geom_vline(aes(xintercept = lowest_conc),
#              color = "black",
#              linetype = "dashed") +
#   geom_vline(aes(xintercept = highest_conc),
#              color = "black",
#              linetype = "solid") +
#   theme_classic() +
#   scale_x_continuous(expand = expansion(add = 1)) +
#   xlab("BMD") +
#   geom_text(
#     mapping = aes(label = paste("Hit =", hit_confidence), x = lowest_conc +
#                     2),
#     y = 1000,
#     inherit.aes = FALSE,
#     size = 4
#   )

#print(p_rcurvep_pearson_distribution_bmds)
```

```{r save_plots_again, include=FALSE}
# ggsave(
#   plot = p_rcurvep_pearson_distribution_bmds,
#   filename = paste0(
#     "Output/p_", params$endpoint, "_", params$method,"_distribution_bmds_",
#     params$sample_size,
#     "_samples.png"
#   ),
#   device = "png",
#   units = "px",
#   width = 1920,
#   height = 1080,
#   bg = "white",
#   scale = 2
# )
```

```{r 62calculating_benchmark_dose_3, echo=FALSE}
 temp <- list(bmds_pearson)
 names(temp) <- c(paste0(params$endpoint, "_", params$method))
 all_summarized_bmd_dat <- plyr::ldply(temp)
 all_summarized_bmd_dat <- all_summarized_bmd_dat %>%
   arrange(chemical)

 all_summarized_bmd_dat %>%
   mutate(lowest_conc = lowest_conc + 1) %>%
   mutate(
     lowest_conc = (10 ^ lowest_conc)*lowest_dose_treatment_group,
     highest_conc = sprintf((10 ^ highest_conc)*lowest_dose_treatment_group, fmt = '%.7f'),
     cil_POD = (10 ^ cil_POD)*lowest_dose_treatment_group,
     POD_med = (10 ^ POD_med)*lowest_dose_treatment_group,
     ciu_POD = (10 ^ ciu_POD)*lowest_dose_treatment_group,
     median_POD = (10 ^ median_POD)*lowest_dose_treatment_group,
     mean_POD = (10 ^ mean_POD)*lowest_dose_treatment_group
   ) %>%
   mutate(POD_med = if_else(is.na(POD_med), true = median_POD, false = POD_med)) %>%
   select(
     chemical,
     .id,
     lowest_conc,
     highest_conc,
     cil_POD,
     median_POD,
     ciu_POD,
     hit_confidence
   ) %>%
   kable(
     col.names = c(
       "Chemical",
       "endpoint",
       "Low Dose (mg/L)",
       "High Dose (mg/L)",
       "BMD - low confidence interval (0.05)",
       "BMD",
       "BMD - high confidence interval (0.95)",
       "Hit Confidence"
     ),
     caption = "Table 9. Summary of all the benchmark doses (BMDs) of every chemical"
   ) %>%
   kable_styling() %>%
   row_spec(
     which(
       all_summarized_bmd_dat$median_POD < all_summarized_bmd_dat$highest_conc
     ),
     bold = TRUE,
     background = "gray"
   ) %>%
   scroll_box()
```

From table 8 it can be seen that this method was not very effective on the current data set likely due to the very low doses used in the chemical exposure study and/or a lack of neurotoxic effects for some chemicals.\
\
   
```{r write_results, include=FALSE}
data <- all_summarized_bmd_dat %>%
   mutate(lowest_conc = lowest_conc + 1) %>%
   mutate(
     lowest_conc = (10 ^ lowest_conc)*lowest_dose_treatment_group,
     highest_conc = sprintf((10 ^ highest_conc)*lowest_dose_treatment_group, fmt = '%.7f'),
     cil_POD = (10 ^ cil_POD)*lowest_dose_treatment_group,
     POD_med = (10 ^ POD_med)*lowest_dose_treatment_group,
     ciu_POD = (10 ^ ciu_POD)*lowest_dose_treatment_group,
     median_POD = (10 ^ median_POD)*lowest_dose_treatment_group,
     mean_POD = (10 ^ mean_POD)*lowest_dose_treatment_group
   ) %>%
   mutate(POD_med = if_else(is.na(POD_med), true = median_POD, false = POD_med))

write_csv(x = data, file = paste0("Output/", "BMDs/", params$endpoint, "_", params$method, "_simi_score_BMDs_", params$sample_size, "_samples.csv"))
```